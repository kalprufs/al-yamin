<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استادیار - سیستم مدیریت حضور و غیاب کلاس</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        @font-face {
            font-family: 'AbarLowFaNum';
            src: url('otf/AbarLowFaNum-Regular.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        body {
            font-family: 'AbarLowFaNum', 'Vazirmatn', 'Tahoma', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            direction: rtl;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            font-weight: 300;
            opacity: 0.9;
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.1);
        }
        
        .tabs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 30px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            padding: 8px;
            gap: 8px;
        }
        
        .tab {
            flex: 1 1 auto;
            min-width: 120px;
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            font-family: inherit;
            border-radius: 12px;
            transition: all 0.3s ease;
            color: #666;
            white-space: nowrap;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .tab:hover:not(.active) {
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(20px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }
        
        .tab-content h2 {
            font-size: 1.8em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 12px;
            border-bottom: 3px solid #667eea;
        }
        
        .class-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .class-selector label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .class-selector select {
            padding: 10px 15px;
            border: 2px solid #e3f2fd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            min-width: 200px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e3f2fd;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }
        
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.3s ease;
            margin: 6px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(40, 167, 69, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #e91e63);
            color: white;
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(220, 53, 69, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #6f42c1);
            color: white;
            box-shadow: 0 8px 20px rgba(23, 162, 184, 0.3);
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(23, 162, 184, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(255, 193, 7, 0.4);
        }
        
        .sessions-list, .students-list, .classes-list {
            margin-top: 25px;
        }
        
        .session-item, .student-item, .class-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-right: 4px solid #667eea;
        }
        
        .session-item:hover, .student-item:hover, .class-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .session-header, .student-header, .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .session-title, .student-name, .class-name {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .session-item p, .student-item p, .class-item p {
            color: #5a6c7d;
            line-height: 1.6;
            margin: 6px 0;
        }
        
        .session-item p strong, .student-item p strong, .class-item p strong {
            color: #2c3e50;
            font-weight: 600;
        }
        
        .attendance-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .attendance-item {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.95));
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            gap: 12px;
        }
        
        .attendance-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .attendance-item input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: #667eea;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .student-name-clickable {
            cursor: pointer;
            color: #667eea;
            font-weight: 500;
            flex-grow: 1;
            transition: all 0.3s ease;
            padding: 4px 8px;
            border-radius: 6px;
            user-select: none;
        }
        
        .student-name-clickable:hover {
            color: #5a6fd8;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .score-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-left: 12px;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.95));
            margin: 3% auto;
            padding: 35px;
            border-radius: 20px;
            width: 90%;
            max-width: 850px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
            position: relative;
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }
        
        .close {
            position: absolute;
            left: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            transition: all 0.3s ease;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.8);
        }
        
        .close:hover {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            transform: rotate(90deg);
        }
        
        .modal h2 {
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 2em;
            font-weight: 700;
            border-bottom: 3px solid #667eea;
            padding-bottom: 12px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0;
            padding: 12px 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #d1d5db;
        }
        
        .checkbox-group:hover {
            border-color: #667eea;
        }
        
        .checkbox-group input[type="checkbox"] {
            order: 2;
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }
        
        .checkbox-group label {
            font-weight: 500;
            color: #000000;
            cursor: pointer;
            order: 1;
        }
        
        .dynamic-list {
            border: 2px solid rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            padding: 18px;
            margin: 12px 0;
            background: rgba(255,255,255,0.4);
        }
        
        .dynamic-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            padding: 12px;
            background: rgba(255,255,255,0.7);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            gap: 10px;
        }
        
        .dynamic-item input {
            flex: 1;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        .score-display {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 18px;
            border-radius: 12px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }
        
        .export-section {
            text-align: center;
            margin: 35px 0;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .export-section h3 {
            font-size: 1.6em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 18px;
        }
        
        .json-section {
            margin: 25px 0;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .json-section h3 {
            font-size: 1.6em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 18px;
        }
        
        .json-section textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e3f2fd;
            border-radius: 12px;
            font-family: monospace;
            font-size: 14px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.8);
        }
        
        .json-section .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-6px) scale(1.03);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .stat-label {
            font-size: 0.95em;
            font-weight: 500;
            margin-top: 8px;
            opacity: 0.9;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 50px 20px;
            background: rgba(255,255,255,0.5);
            border-radius: 12px;
            border: 2px dashed rgba(153,153,153,0.3);
        }
        
        .bulk-add-section {
            margin-top: 18px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .bulk-add-section h3 {
            margin-bottom: 12px;
            color: #2c3e50;
        }
        
        .bulk-add-section p {
            color: #666;
            margin-bottom: 12px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #17a2b8, #6f42c1);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 6px;
        }
        
        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(23, 162, 184, 0.4);
        }
        
        .json-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .main-content {
                padding: 20px 15px;
                border-radius: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 0.95em;
            }
            
            .tabs {
                padding: 6px;
            }
            
            .tab {
                min-width: calc(50% - 8px);
                padding: 12px 15px;
                font-size: 13px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .attendance-list {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .stat-number {
                font-size: 2em;
            }
            
            .modal-content {
                width: 95%;
                margin: 3% auto;
                padding: 25px 18px;
            }
            
            .session-header, .student-header, .class-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .btn {
                padding: 10px 18px;
                font-size: 13px;
                margin: 4px;
            }
            
            .class-selector {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .class-selector select {
                min-width: 100%;
            }
            
            .json-section .btn-group {
                flex-direction: column;
            }
            
            .json-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>استادیار</h1>
            <p>مدیریت کامل کلاس‌ها، جلسات، دانشجویان و امتیازدهی</p>
        </div>
        
        <div class="main-content">
            <div class="tabs">
                <button class="tab" onclick="showTab('classes')">کلاس‌ها</button>
                <button class="tab active" onclick="showTab('sessions')">جلسات</button>
                <button class="tab" onclick="showTab('students')">دانشجویان</button>
                <button class="tab" onclick="showTab('attendance')">حضور و غیاب</button>
                <button class="tab" onclick="showTab('reports')">گزارشات</button>
            </div>
            
            <div id="classes" class="tab-content">
                <h2>مدیریت کلاس‌ها</h2>
                <form id="classForm">
                    <div class="form-group">
                        <label>نام کلاس:</label>
                        <input type="text" id="className" required>
                    </div>
                    <div class="form-group">
                        <label>توضیحات:</label>
                        <textarea id="classDescription" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">افزودن کلاس</button>
                </form>
                
                <div class="classes-list" id="classesList"></div>
                
                <!-- بخش وارد کردن JSON -->
                <div class="json-section">
                    <h3>مدیریت داده‌ها</h3>
                    <p style="margin-bottom: 15px; color: #666;">می‌توانید اطلاعات را وارد یا خارج کنید:</p>
                    
                    <div class="json-buttons">
                        <button onclick="openImportModal()" class="btn btn-info">وارد کردن اطلاعات از JSON</button>
                        <button onclick="openExcelImportModal()" class="btn btn-success">وارد کردن اطلاعات از Excel</button>
                        <button onclick="resetData()" class="btn btn-danger">بازنشانی همه اطلاعات</button>
                    </div>
                </div>
            </div>
            
            <div id="sessions" class="tab-content active">
                <h2>مدیریت جلسات</h2>
                <div class="class-selector">
                    <label>انتخاب کلاس:</label>
                    <select id="sessionClass" onchange="renderSessions()">
                        <option value="">-- انتخاب کنید --</option>
                    </select>
                </div>
                <form id="sessionForm">
                    <div class="form-group">
                        <label>عنوان جلسه:</label>
                        <input type="text" id="sessionTitle" required>
                    </div>
                    <div class="form-group">
                        <label>تاریخ جلسه (شمسی):</label>
                        <input type="text" id="sessionDate" placeholder="مثال: 1403/07/12" required>
                    </div>
                    <div class="form-group">
                        <label>توضیحات:</label>
                        <textarea id="sessionDescription" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">افزودن جلسه</button>
                </form>
                
                <div class="sessions-list" id="sessionsList"></div>
            </div>
            
            <div id="students" class="tab-content">
                <h2>مدیریت دانشجویان</h2>
                <div class="class-selector">
                    <label>انتخاب کلاس:</label>
                    <select id="studentClass" onchange="renderStudents()">
                        <option value="">-- انتخاب کنید --</option>
                    </select>
                </div>
                <form id="studentForm">
                    <div class="form-group">
                        <label>نام دانشجو:</label>
                        <input type="text" id="studentName" required>
                    </div>
                    <div class="form-group">
                        <label>توضیحات کلی:</label>
                        <textarea id="studentNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">افزودن دانشجو</button>
                    <button type="button" onclick="toggleBulkAdd()" class="btn btn-info">افزودن گروهی</button>
                    <button type="button" onclick="deleteAllStudents()" class="btn btn-danger">حذف همه دانشجویان</button>
                </form>
                
                <div id="bulkAddSection" class="bulk-add-section" style="display: none;">
                    <h3>افزودن چند دانشجو به صورت همزمان</h3>
                    <p>هر نام را در یک خط جداگانه وارد کنید:</p>
                    <textarea id="bulkStudentNames" rows="8" placeholder="دانشجو ۱&#10;دانشجو ۲&#10;دانشجو ۳&#10;..." style="width: 100%; padding: 14px 18px; border: 2px solid #e3f2fd; border-radius: 12px; font-size: 14px; font-family: inherit; background: rgba(255, 255, 255, 0.8);"></textarea>
                    <div style="margin-top: 12px;">
                        <button type="button" onclick="addBulkStudents()" class="btn btn-success">افزودن همه</button>
                        <button type="button" onclick="toggleBulkAdd()" class="btn btn-danger">انصراف</button>
                    </div>
                </div>
                
                <div class="students-list" id="studentsList"></div>
            </div>
            
            <div id="attendance" class="tab-content">
                <h2>حضور و غیاب</h2>
                <div class="class-selector">
                    <label>انتخاب کلاس:</label>
                    <select id="attendanceClass" onchange="renderAttendance()">
                        <option value="">-- انتخاب کنید --</option>
                    </select>
                </div>
                <div id="attendanceContent"></div>
            </div>
            
            <div id="reports" class="tab-content">
                <h2>گزارشات و آمار</h2>
                <div class="class-selector">
                    <label>انتخاب کلاس:</label>
                    <select id="reportClass" onchange="renderStats()">
                        <option value="">-- انتخاب کنید --</option>
                    </select>
                </div>
                <div class="stats-grid" id="statsGrid"></div>
                
                <div class="export-section">
                    <h3>خروجی داده‌ها</h3>
                    <p style="margin-bottom: 18px; color: #666;">تمام اطلاعات را در قالب فایل Excel دریافت کنید</p>
                    <button onclick="exportToExcel()" class="btn btn-success">دانلود فایل Excel</button>
                </div>
                
                <!-- بخش خروجی JSON -->
                <div class="json-section">
                    <h3>خروجی گرفتن اطلاعات</h3>
                    <p style="margin-bottom: 15px; color: #666;">می‌توانید تمام اطلاعات را به صورت JSON ذخیره کنید:</p>
                    
                    <div class="json-buttons">
                        <button onclick="openExportModal()" class="btn btn-warning">خروجی JSON</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- مودال جزئیات دانشجو -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('studentModal')">&times;</span>
            <h2>جزئیات دانشجو</h2>
            <form id="studentDetailsForm">
                <input type="hidden" id="modalStudentId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>نام دانشجو:</label>
                        <input type="text" id="modalStudentName" readonly>
                    </div>
                    <div class="form-group">
                        <label>کد دانشجویی:</label>
                        <input type="text" id="modalStudentCode">
                    </div>
                    <div class="form-group">
                        <label>شهر محل زندگی:</label>
                        <input type="text" id="modalCity">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>رشته اصلی:</label>
                        <input type="text" id="modalMajor">
                    </div>
                    <div class="form-group">
                        <label>رشته فرعی:</label>
                        <input type="text" id="modalMinor">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>کتاب‌های مطالعه‌شده:</label>
                    <div class="dynamic-list" id="booksList">
                        <button type="button" onclick="addBook()" class="btn btn-info">+ افزودن کتاب</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>فیلم‌های دیده‌شده:</label>
                    <div class="dynamic-list" id="moviesList">
                        <button type="button" onclick="addMovie()" class="btn btn-info">+ افزودن فیلم</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>سریال‌های دیده‌شده:</label>
                    <div class="dynamic-list" id="seriesList">
                        <button type="button" onclick="addSeries()" class="btn btn-info">+ افزودن سریال</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>وضعیت امتیازات ثابت:</label>
                    <div class="checkbox-group">
                        <label>متأهل</label>
                        <input type="checkbox" id="modalIsMarried">
                        <input type="number" id="modalIsMarriedPoints" placeholder="امتیاز" style="width: 80px; margin-right: 10px;">
                    </div>
                    <div class="checkbox-group">
                        <label>داشتن فرزند</label>
                        <input type="checkbox" id="modalHasChild">
                        <input type="number" id="modalHasChildPoints" placeholder="امتیاز" style="width: 80px; margin-right: 10px;">
                    </div>
                    <div class="checkbox-group">
                        <label>داشتن شغل</label>
                        <input type="checkbox" id="modalHasJob">
                        <input type="number" id="modalHasJobPoints" placeholder="امتیاز" style="width: 80px; margin-right: 10px;">
                    </div>
                    <div class="checkbox-group">
                        <label>داشتن مقام یا قهرمانی</label>
                        <input type="checkbox" id="modalHasAchievement">
                        <input type="number" id="modalHasAchievementPoints" placeholder="امتیاز" style="width: 80px; margin-right: 10px;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>امتیازات این جلسه:</label>
                    <div id="currentSessionScores"></div>
                </div>
                
                <div class="form-group">
                    <label>امتیازات دلخواه این جلسه:</label>
                    <div class="dynamic-list" id="customSessionScores">
                        <button type="button" onclick="addCustomSessionScore()" class="btn btn-info">+ افزودن امتیاز دلخواه</button>
                    </div>
                </div>
                
                <div class="score-display" id="totalScoreDisplay">امتیاز کل: 0</div>
                
                <div class="form-group">
                    <label>توضیحات کلی:</label>
                    <textarea id="modalStudentNotes" rows="3"></textarea>
                </div>
                
                <button type="button" onclick="saveStudentDetails()" class="btn btn-primary">ذخیره جزئیات</button>
                <button type="button" onclick="closeModal('studentModal')" class="btn btn-danger">انصراف</button>
            </form>
        </div>
    </div>
    
    <!-- مودال خروجی JSON -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('exportModal')">&times;</span>
            <h2>خروجی گرفتن اطلاعات</h2>
            <p style="margin-bottom: 15px; color: #666;">می‌توانید تمام اطلاعات را کپی کرده و در جایی ذخیره کنید:</p>
            <textarea id="exportData" readonly></textarea>
            <div class="json-buttons">
                <button onclick="copyExportData()" class="btn btn-primary">کپی اطلاعات</button>
                <button onclick="closeModal('exportModal')" class="btn btn-danger">بستن</button>
            </div>
        </div>
    </div>
    
    <!-- مودال وارد کردن JSON -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('importModal')">&times;</span>
            <h2>وارد کردن اطلاعات از JSON</h2>
            <p style="margin-bottom: 15px; color: #666;">اطلاعات JSON را در کادر زیر وارد کنید:</p>
            <textarea id="importData" placeholder='{"classes": [], "students": [], "sessions": [], "attendance": []}'></textarea>
            <div class="json-buttons">
                <button onclick="importFromJSON()" class="btn btn-primary">وارد کردن اطلاعات</button>
                <button onclick="closeModal('importModal')" class="btn btn-danger">انصراف</button>
            </div>
        </div>
    </div>
    
    <!-- مودال وارد کردن Excel -->
    <div id="excelImportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('excelImportModal')">&times;</span>
            <h2>وارد کردن اطلاعات از Excel</h2>
            <p style="margin-bottom: 15px; color: #666;">یک فایل Excel که قبلاً از این سیستم خروجی گرفته‌اید را انتخاب کنید:</p>
            
            <div style="text-align: center; margin: 20px 0;">
                <input type="file" id="excelFile" accept=".xlsx, .xls" class="file-input">
                <label for="excelFile" class="file-label">انتخاب فایل Excel</label>
            </div>
            
            <div style="margin: 20px 0; padding: 15px; background: rgba(255, 255, 255, 0.5); border-radius: 10px;">
                <h3 style="margin-bottom: 10px;">انتخاب نحوه وارد کردن:</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="importMode" value="replace" checked>
                        <span>جایگزینی همه اطلاعات</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="importMode" value="merge">
                        <span>ادغام با اطلاعات موجود</span>
                    </label>
                </div>
            </div>
            
            <div class="json-buttons">
                <button onclick="importFromExcel()" class="btn btn-primary">وارد کردن اطلاعات</button>
                <button onclick="closeModal('excelImportModal')" class="btn btn-danger">انصراف</button>
            </div>
        </div>
    </div>

    <script>
        // Persian/Farsi alphabetical order helper function
        const persianAlphabet = [
            'آ', 'ا', 'ب', 'پ', 'ت', 'ث', 'ج', 'چ', 'ح', 'خ', 'د', 'ذ', 'ر', 'ز', 'ژ', 'س', 'ش', 'ص', 'ض', 'ط', 'ظ', 'ع', 'غ', 'ف', 'ق', 'ک', 'گ', 'ل', 'م', 'ن', 'و', 'ه', 'ی'
        ];

        // Function to sort students alphabetically with last name first
        function sortStudentsAlphabetically(students) {
            return students.sort((a, b) => {
                // Extract last name (assume it's the last word in the name)
                const getLastName = (name) => {
                    const words = name.trim().split(' ');
                    return words.length > 1 ? words[words.length - 1] : name;
                };

                const lastNameA = getLastName(a.name);
                const lastNameB = getLastName(b.name);

                // Compare by last name first
                for (let i = 0; i < Math.min(lastNameA.length, lastNameB.length); i++) {
                    const charA = persianAlphabet.indexOf(lastNameA[i]);
                    const charB = persianAlphabet.indexOf(lastNameB[i]);
                    
                    if (charA !== charB) {
                        return charA - charB;
                    }
                }

                // If last names are equal, compare by full name
                for (let i = 0; i < Math.min(a.name.length, b.name.length); i++) {
                    const charA = persianAlphabet.indexOf(a.name[i]);
                    const charB = persianAlphabet.indexOf(b.name[i]);
                    
                    if (charA !== charB) {
                        return charA - charB;
                    }
                }

                return a.name.length - b.name.length;
            });
        }

        // Data structure
        let data = {
            classes: [],
            students: [],
            sessions: [],
            attendance: []
        };

        // Load data from localStorage
        function loadData() {
            const savedData = localStorage.getItem('classManagerData');
            if (savedData) {
                data = JSON.parse(savedData);
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('classManagerData', JSON.stringify(data));
        }

        // Initialize the app
        function init() {
            loadData();
            renderClasses();
            renderClassSelectors();
            showTab('sessions');
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Render content based on tab
            switch(tabName) {
                case 'classes':
                    renderClasses();
                    break;
                case 'sessions':
                    renderSessions();
                    break;
                case 'students':
                    renderStudents();
                    break;
                case 'attendance':
                    renderAttendance();
                    break;
                case 'reports':
                    renderStats();
                    break;
            }
        }

        // Render classes
        function renderClasses() {
            const classesList = document.getElementById('classesList');
            classesList.innerHTML = '';
            
            if (data.classes.length === 0) {
                classesList.innerHTML = '<div class="empty-state">هنوز کلاسی اضافه نشده است.</div>';
                return;
            }
            
            data.classes.forEach((cls, index) => {
                const classItem = document.createElement('div');
                classItem.className = 'class-item';
                classItem.innerHTML = `
                    <div class="class-header">
                        <div class="class-name">${cls.name}</div>
                        <div>
                            <button onclick="editClass(${index})" class="btn btn-info">ویرایش</button>
                            <button onclick="deleteClass(${index})" class="btn btn-danger">حذف</button>
                        </div>
                    </div>
                    <p><strong>توضیحات:</strong> ${cls.description || 'بدون توضیحات'}</p>
                `;
                classesList.appendChild(classItem);
            });
        }

        // Render class selectors
        function renderClassSelectors() {
            const classSelectors = [
                'sessionClass',
                'studentClass',
                'attendanceClass',
                'reportClass'
            ];
            
            classSelectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                selector.innerHTML = '<option value="">-- انتخاب کنید --</option>';
                
                data.classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    selector.appendChild(option);
                });
            });
        }

        // Add class
        document.getElementById('classForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const className = document.getElementById('className').value;
            const classDescription = document.getElementById('classDescription').value;
            
            const newClass = {
                id: Date.now().toString(),
                name: className,
                description: classDescription
            };
            
            data.classes.push(newClass);
            saveData();
            renderClasses();
            renderClassSelectors();
            
            this.reset();
        });

        // Edit class
        function editClass(index) {
            const cls = data.classes[index];
            const newName = prompt('نام جدید کلاس:', cls.name);
            if (newName) {
                const newDescription = prompt('توضیحات جدید:', cls.description || '');
                data.classes[index].name = newName;
                data.classes[index].description = newDescription;
                saveData();
                renderClasses();
                renderClassSelectors();
            }
        }

        // Delete class
        function deleteClass(index) {
            if (confirm('آیا از حذف این کلاس مطمئن هستید؟')) {
                const classId = data.classes[index].id;
                
                // Remove class
                data.classes.splice(index, 1);
                
                // Remove related students
                data.students = data.students.filter(student => student.classId !== classId);
                
                // Remove related sessions
                data.sessions = data.sessions.filter(session => session.classId !== classId);
                
                // Remove related attendance
                data.attendance = data.attendance.filter(record => record.classId !== classId);
                
                saveData();
                renderClasses();
                renderClassSelectors();
                renderSessions();
                renderStudents();
                renderAttendance();
                renderStats();
            }
        }

        // Render sessions
        function renderSessions() {
            const sessionsList = document.getElementById('sessionsList');
            sessionsList.innerHTML = '';
            
            const classId = document.getElementById('sessionClass').value;
            if (!classId) {
                sessionsList.innerHTML = '<div class="empty-state">لطفاً یک کلاس انتخاب کنید.</div>';
                return;
            }
            
            const classSessions = data.sessions.filter(session => session.classId === classId);
            
            if (classSessions.length === 0) {
                sessionsList.innerHTML = '<div class="empty-state">هنوز جلسه‌ای برای این کلاس اضافه نشده است.</div>';
                return;
            }
            
            classSessions.forEach((session, index) => {
                const sessionItem = document.createElement('div');
                sessionItem.className = 'session-item';
                sessionItem.innerHTML = `
                    <div class="session-header">
                        <div class="session-title">${session.title}</div>
                        <div>
                            <button onclick="editSession('${session.id}')" class="btn btn-info">ویرایش</button>
                            <button onclick="deleteSession('${session.id}')" class="btn btn-danger">حذف</button>
                        </div>
                    </div>
                    <p><strong>تاریخ:</strong> ${session.date}</p>
                    <p><strong>توضیحات:</strong> ${session.description || 'بدون توضیحات'}</p>
                `;
                sessionsList.appendChild(sessionItem);
            });
        }

        // Add session
        document.getElementById('sessionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const classId = document.getElementById('sessionClass').value;
            if (!classId) {
                alert('لطفاً یک کلاس انتخاب کنید.');
                return;
            }
            
            const sessionTitle = document.getElementById('sessionTitle').value;
            const sessionDate = document.getElementById('sessionDate').value;
            const sessionDescription = document.getElementById('sessionDescription').value;
            
            const newSession = {
                id: Date.now().toString(),
                classId: classId,
                title: sessionTitle,
                date: sessionDate,
                description: sessionDescription
            };
            
            data.sessions.push(newSession);
            saveData();
            renderSessions();
            
            this.reset();
        });

        // Edit session
        function editSession(sessionId) {
            const sessionIndex = data.sessions.findIndex(s => s.id === sessionId);
            if (sessionIndex === -1) return;
            
            const session = data.sessions[sessionIndex];
            const newTitle = prompt('عنوان جدید جلسه:', session.title);
            if (newTitle) {
                const newDate = prompt('تاریخ جدید (شمسی):', session.date);
                const newDescription = prompt('توضیحات جدید:', session.description || '');
                
                data.sessions[sessionIndex].title = newTitle;
                data.sessions[sessionIndex].date = newDate;
                data.sessions[sessionIndex].description = newDescription;
                
                saveData();
                renderSessions();
            }
        }

        // Delete session
        function deleteSession(sessionId) {
            if (confirm('آیا از حذف این جلسه مطمئن هستید؟')) {
                // Remove session
                data.sessions = data.sessions.filter(session => session.id !== sessionId);
                
                // Remove related attendance records
                data.attendance = data.attendance.filter(record => record.sessionId !== sessionId);
                
                saveData();
                renderSessions();
                renderAttendance();
            }
        }

        // Render students
        function renderStudents() {
            const studentsList = document.getElementById('studentsList');
            studentsList.innerHTML = '';
            
            const classId = document.getElementById('studentClass').value;
            if (!classId) {
                studentsList.innerHTML = '<div class="empty-state">لطفاً یک کلاس انتخاب کنید.</div>';
                return;
            }
            
            const classStudents = data.students.filter(student => student.classId === classId);
            
            if (classStudents.length === 0) {
                studentsList.innerHTML = '<div class="empty-state">هنوز دانشجویی برای این کلاس اضافه نشده است.</div>';
                return;
            }
            
            // Sort students alphabetically
            const sortedStudents = sortStudentsAlphabetically(classStudents);
            
            sortedStudents.forEach(student => {
                const studentItem = document.createElement('div');
                studentItem.className = 'student-item';
                
                const totalScore = calculateTotalScore(student);
                
                studentItem.innerHTML = `
                    <div class="student-header">
                        <div class="student-name">${student.name}</div>
                        <div>
                            <span class="score-badge">امتیاز کل: ${totalScore}</span>
                            <button onclick="openStudentDetails('${student.id}')" class="btn btn-info">جزئیات</button>
                            <button onclick="deleteStudent('${student.id}')" class="btn btn-danger">حذف</button>
                        </div>
                    </div>
                    <p><strong>توضیحات:</strong> ${student.notes || 'بدون توضیحات'}</p>
                `;
                studentsList.appendChild(studentItem);
            });
        }

        // Add student
        document.getElementById('studentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const classId = document.getElementById('studentClass').value;
            if (!classId) {
                alert('لطفاً یک کلاس انتخاب کنید.');
                return;
            }
            
            const studentName = document.getElementById('studentName').value;
            const studentNotes = document.getElementById('studentNotes').value;
            
            const newStudent = {
                id: Date.now().toString(),
                classId: classId,
                name: studentName,
                notes: studentNotes,
                details: {
                    code: '',
                    city: '',
                    major: '',
                    minor: '',
                    books: [],
                    movies: [],
                    series: [],
                    fixedScores: {
                        isMarried: { checked: false, points: 0 },
                        hasChild: { checked: false, points: 0 },
                        hasJob: { checked: false, points: 0 },
                        hasAchievement: { checked: false, points: 0 }
                    },
                    sessionScores: {}
                }
            };
            
            data.students.push(newStudent);
            saveData();
            renderStudents();
            
            this.reset();
        });

        // Toggle bulk add section
        function toggleBulkAdd() {
            const bulkSection = document.getElementById('bulkAddSection');
            bulkSection.style.display = bulkSection.style.display === 'none' ? 'block' : 'none';
        }

        // Add bulk students
        function addBulkStudents() {
            const classId = document.getElementById('studentClass').value;
            if (!classId) {
                alert('لطفاً یک کلاس انتخاب کنید.');
                return;
            }
            
            const bulkNames = document.getElementById('bulkStudentNames').value;
            if (!bulkNames.trim()) {
                alert('لطفاً نام دانشجویان را وارد کنید.');
                return;
            }
            
            const names = bulkNames.split('\n').filter(name => name.trim());
            
            names.forEach(name => {
                if (name.trim()) {
                    const newStudent = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                        classId: classId,
                        name: name.trim(),
                        notes: '',
                        details: {
                            code: '',
                            city: '',
                            major: '',
                            minor: '',
                            books: [],
                            movies: [],
                            series: [],
                            fixedScores: {
                                isMarried: { checked: false, points: 0 },
                                hasChild: { checked: false, points: 0 },
                                hasJob: { checked: false, points: 0 },
                                hasAchievement: { checked: false, points: 0 }
                            },
                            sessionScores: {}
                        }
                    };
                    
                    data.students.push(newStudent);
                }
            });
            
            saveData();
            renderStudents();
            toggleBulkAdd();
            document.getElementById('bulkStudentNames').value = '';
        }

        // Delete all students
        function deleteAllStudents() {
            const classId = document.getElementById('studentClass').value;
            if (!classId) {
                alert('لطفاً یک کلاس انتخاب کنید.');
                return;
            }
            
            if (confirm('آیا از حذف همه دانشجویان این کلاس مطمئن هستید؟')) {
                data.students = data.students.filter(student => student.classId !== classId);
                saveData();
                renderStudents();
            }
        }

        // Delete student
        function deleteStudent(studentId) {
            if (confirm('آیا از حذف این دانشجو مطمئن هستید؟')) {
                // Remove student
                data.students = data.students.filter(student => student.id !== studentId);
                
                // Remove related attendance records
                data.attendance = data.attendance.filter(record => record.studentId !== studentId);
                
                saveData();
                renderStudents();
                renderAttendance();
            }
        }

        // Open student details modal
        function openStudentDetails(studentId) {
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            document.getElementById('modalStudentId').value = studentId;
            document.getElementById('modalStudentName').value = student.name;
            document.getElementById('modalStudentCode').value = student.details.code || '';
            document.getElementById('modalCity').value = student.details.city || '';
            document.getElementById('modalMajor').value = student.details.major || '';
            document.getElementById('modalMinor').value = student.details.minor || '';
            document.getElementById('modalStudentNotes').value = student.notes || '';
            
            // Fixed scores
            document.getElementById('modalIsMarried').checked = student.details.fixedScores.isMarried.checked;
            document.getElementById('modalIsMarriedPoints').value = student.details.fixedScores.isMarried.points;
            document.getElementById('modalHasChild').checked = student.details.fixedScores.hasChild.checked;
            document.getElementById('modalHasChildPoints').value = student.details.fixedScores.hasChild.points;
            document.getElementById('modalHasJob').checked = student.details.fixedScores.hasJob.checked;
            document.getElementById('modalHasJobPoints').value = student.details.fixedScores.hasJob.points;
            document.getElementById('modalHasAchievement').checked = student.details.fixedScores.hasAchievement.checked;
            document.getElementById('modalHasAchievementPoints').value = student.details.fixedScores.hasAchievement.points;
            
            // Books
            const booksList = document.getElementById('booksList');
            booksList.innerHTML = '<button type="button" onclick="addBook()" class="btn btn-info">+ افزودن کتاب</button>';
            student.details.books.forEach((book, index) => {
                const bookItem = document.createElement('div');
                bookItem.className = 'dynamic-item';
                bookItem.innerHTML = `
                    <input type="text" value="${book.title}" placeholder="نام کتاب" onchange="updateBook(${index}, this.value)">
                    <input type="number" value="${book.points}" placeholder="امتیاز" onchange="updateBookPoints(${index}, this.value)">
                    <button type="button" onclick="removeBook(${index})" class="btn btn-danger">حذف</button>
                `;
                booksList.appendChild(bookItem);
            });
            
            // Movies
            const moviesList = document.getElementById('moviesList');
            moviesList.innerHTML = '<button type="button" onclick="addMovie()" class="btn btn-info">+ افزودن فیلم</button>';
            student.details.movies.forEach((movie, index) => {
                const movieItem = document.createElement('div');
                movieItem.className = 'dynamic-item';
                movieItem.innerHTML = `
                    <input type="text" value="${movie.title}" placeholder="نام فیلم" onchange="updateMovie(${index}, this.value)">
                    <input type="number" value="${movie.points}" placeholder="امتیاز" onchange="updateMoviePoints(${index}, this.value)">
                    <button type="button" onclick="removeMovie(${index})" class="btn btn-danger">حذف</button>
                `;
                moviesList.appendChild(movieItem);
            });
            
            // Series
            const seriesList = document.getElementById('seriesList');
            seriesList.innerHTML = '<button type="button" onclick="addSeries()" class="btn btn-info">+ افزودن سریال</button>';
            student.details.series.forEach((series, index) => {
                const seriesItem = document.createElement('div');
                seriesItem.className = 'dynamic-item';
                seriesItem.innerHTML = `
                    <input type="text" value="${series.title}" placeholder="نام سریال" onchange="updateSeries(${index}, this.value)">
                    <input type="number" value="${series.points}" placeholder="امتیاز" onchange="updateSeriesPoints(${index}, this.value)">
                    <button type="button" onclick="removeSeries(${index})" class="btn btn-danger">حذف</button>
                `;
                seriesList.appendChild(seriesItem);
            });
            
            // Current session scores
            const currentSessionScores = document.getElementById('currentSessionScores');
            currentSessionScores.innerHTML = '';
            
            // Custom session scores
            const customSessionScores = document.getElementById('customSessionScores');
            customSessionScores.innerHTML = '<button type="button" onclick="addCustomSessionScore()" class="btn btn-info">+ افزودن امتیاز دلخواه</button>';
            
            // Update total score display
            updateTotalScoreDisplay();
            
            openModal('studentModal');
        }

        // Add book
        function addBook() {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.details.books.push({ title: '', points: 0 });
            saveData();
            openStudentDetails(studentId);
        }

        // Update book
        function updateBook(index, value) {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.details.books[index].title = value;
            saveData();
            updateTotalScoreDisplay();
        }

        // Update book points
        function updateBookPoints(index, value) {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.details.books[index].points = parseInt(value) || 0;
            saveData();
            updateTotalScoreDisplay();
        }

        // Remove book
        function removeBook(index) {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.details.books.splice(index, 1);
            saveData();
            openStudentDetails(studentId);
        }

        // Add movie
        function addMovie() {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.details.movies.push({ title: '', points: 0 });
            saveData();
            openStudentDetails(studentId);
        }

        // Update movie
        function updateMovie(index, value) {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.details.movies[index].title = value;
            saveData();
            updateTotalScoreDisplay();
        }

        // Update movie points
        function updateMoviePoints(index, value) {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.details.movies[index].points = parseInt(value) || 0;
            saveData();
            updateTotalScoreDisplay();
        }

        // Remove movie
        function removeMovie(index) {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.details.movies.splice(index, 1);
            saveData();
            openStudentDetails(studentId);
        }

        // Add series
        function addSeries() {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.details.series.push({ title: '', points: 0 });
            saveData();
            openStudentDetails(studentId);
        }

        // Update series
        function updateSeries(index, value) {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.details.series[index].title = value;
            saveData();
            updateTotalScoreDisplay();
        }

        // Update series points
        function updateSeriesPoints(index, value) {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.details.series[index].points = parseInt(value) || 0;
            saveData();
            updateTotalScoreDisplay();
        }

        // Remove series
        function removeSeries(index) {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.details.series.splice(index, 1);
            saveData();
            openStudentDetails(studentId);
        }

        // Add custom session score
        function addCustomSessionScore() {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            const scoreId = Date.now().toString();
            if (!student.details.sessionScores) {
                student.details.sessionScores = {};
            }
            student.details.sessionScores[scoreId] = { title: '', points: 0 };
            saveData();
            openStudentDetails(studentId);
        }

        // Save student details
        function saveStudentDetails() {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.details.code = document.getElementById('modalStudentCode').value;
            student.details.city = document.getElementById('modalCity').value;
            student.details.major = document.getElementById('modalMajor').value;
            student.details.minor = document.getElementById('modalMinor').value;
            student.notes = document.getElementById('modalStudentNotes').value;
            
            // Fixed scores
            student.details.fixedScores.isMarried.checked = document.getElementById('modalIsMarried').checked;
            student.details.fixedScores.isMarried.points = parseInt(document.getElementById('modalIsMarriedPoints').value) || 0;
            student.details.fixedScores.hasChild.checked = document.getElementById('modalHasChild').checked;
            student.details.fixedScores.hasChild.points = parseInt(document.getElementById('modalHasChildPoints').value) || 0;
            student.details.fixedScores.hasJob.checked = document.getElementById('modalHasJob').checked;
            student.details.fixedScores.hasJob.points = parseInt(document.getElementById('modalHasJobPoints').value) || 0;
            student.details.fixedScores.hasAchievement.checked = document.getElementById('modalHasAchievement').checked;
            student.details.fixedScores.hasAchievement.points = parseInt(document.getElementById('modalHasAchievementPoints').value) || 0;
            
            saveData();
            closeModal('studentModal');
            renderStudents();
        }

        // Calculate total score
        function calculateTotalScore(student) {
            let total = 0;
            
            // Books
            if (student.details.books) {
                total += student.details.books.reduce((sum, book) => sum + (book.points || 0), 0);
            }
            
            // Movies
            if (student.details.movies) {
                total += student.details.movies.reduce((sum, movie) => sum + (movie.points || 0), 0);
            }
            
            // Series
            if (student.details.series) {
                total += student.details.series.reduce((sum, series) => sum + (series.points || 0), 0);
            }
            
            // Fixed scores
            if (student.details.fixedScores) {
                Object.values(student.details.fixedScores).forEach(score => {
                    if (score.checked) {
                        total += score.points || 0;
                    }
                });
            }
            
            // Session scores
            if (student.details.sessionScores) {
                Object.values(student.details.sessionScores).forEach(score => {
                    total += score.points || 0;
                });
            }
            
            return total;
        }

        // Update total score display
        function updateTotalScoreDisplay() {
            const studentId = document.getElementById('modalStudentId').value;
            const student = data.students.find(s => s.id === studentId);
            if (!student) return;
            
            const totalScore = calculateTotalScore(student);
            document.getElementById('totalScoreDisplay').textContent = `امتیاز کل: ${totalScore}`;
        }

        // Render attendance
        function renderAttendance() {
            const attendanceContent = document.getElementById('attendanceContent');
            attendanceContent.innerHTML = '';
            
            const classId = document.getElementById('attendanceClass').value;
            if (!classId) {
                attendanceContent.innerHTML = '<div class="empty-state">لطفاً یک کلاس انتخاب کنید.</div>';
                return;
            }
            
            const classSessions = data.sessions.filter(session => session.classId === classId);
            const classStudents = data.students.filter(student => student.classId === classId);
            
            if (classSessions.length === 0) {
                attendanceContent.innerHTML = '<div class="empty-state">هنوز جلسه‌ای برای این کلاس وجود ندارد.</div>';
                return;
            }
            
            if (classStudents.length === 0) {
                attendanceContent.innerHTML = '<div class="empty-state">هنوز دانشجویی برای این کلاس وجود ندارد.</div>';
                return;
            }
            
            // Sort students alphabetically
            const sortedStudents = sortStudentsAlphabetically(classStudents);
            
            // Create session selector
            const sessionSelector = document.createElement('select');
            sessionSelector.id = 'attendanceSession';
            sessionSelector.innerHTML = '<option value="">-- انتخاب جلسه --</option>';
            classSessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.id;
                option.textContent = `${session.title} (${session.date})`;
                sessionSelector.appendChild(option);
            });
            sessionSelector.onchange = renderAttendanceList;
            
            const selectorContainer = document.createElement('div');
            selectorContainer.className = 'class-selector';
            selectorContainer.innerHTML = '<label>انتخاب جلسه:</label>';
            selectorContainer.appendChild(sessionSelector);
            
            attendanceContent.appendChild(selectorContainer);
            attendanceContent.appendChild(document.createElement('div')).id = 'attendanceList';
        }

        // Render attendance list
        function renderAttendanceList() {
            const attendanceList = document.getElementById('attendanceList');
            attendanceList.innerHTML = '';
            
            const sessionId = document.getElementById('attendanceSession').value;
            if (!sessionId) return;
            
            const classId = document.getElementById('attendanceClass').value;
            const classStudents = data.students.filter(student => student.classId === classId);
            
            // Sort students alphabetically
            const sortedStudents = sortStudentsAlphabetically(classStudents);
            
            const attendanceContainer = document.createElement('div');
            attendanceContainer.className = 'attendance-list';
            
            sortedStudents.forEach(student => {
                const isPresent = data.attendance.some(record => 
                    record.sessionId === sessionId && record.studentId === student.id
                );
                
                const attendanceItem = document.createElement('div');
                attendanceItem.className = 'attendance-item';
                attendanceItem.innerHTML = `
                    <input type="checkbox" id="attendance_${student.id}" ${isPresent ? 'checked' : ''} onchange="toggleAttendance('${sessionId}', '${student.id}')">
                    <label for="attendance_${student.id}" class="student-name-clickable" onclick="openStudentDetails('${student.id}')">${student.name}</label>
                    <span class="score-badge">${calculateTotalScore(student)}</span>
                `;
                attendanceContainer.appendChild(attendanceItem);
            });
            
            attendanceList.appendChild(attendanceContainer);
            
            const saveButton = document.createElement('button');
            saveButton.className = 'btn btn-primary';
            saveButton.textContent = 'ذخیره حضور و غیاب';
            saveButton.onclick = saveAttendance;
            saveButton.style.marginTop = '20px';
            attendanceList.appendChild(saveButton);
        }

        // Toggle attendance
        function toggleAttendance(sessionId, studentId) {
            const existingIndex = data.attendance.findIndex(record => 
                record.sessionId === sessionId && record.studentId === studentId
            );
            
            const checkbox = document.getElementById(`attendance_${studentId}`);
            
            if (checkbox.checked) {
                if (existingIndex === -1) {
                    data.attendance.push({
                        sessionId: sessionId,
                        studentId: studentId,
                        date: new Date().toISOString()
                    });
                }
            } else {
                if (existingIndex !== -1) {
                    data.attendance.splice(existingIndex, 1);
                }
            }
            
            saveData();
        }

        // Save attendance
        function saveAttendance() {
            saveData();
            alert('حضور و غیاب با موفقیت ذخیره شد.');
        }

        // Render stats
        function renderStats() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';
            
            const classId = document.getElementById('reportClass').value;
            if (!classId) {
                statsGrid.innerHTML = '<div class="empty-state">لطفاً یک کلاس انتخاب کنید.</div>';
                return;
            }
            
            const classStudents = data.students.filter(student => student.classId === classId);
            const classSessions = data.sessions.filter(session => session.classId === classId);
            
            // Sort students alphabetically
            const sortedStudents = sortStudentsAlphabetically(classStudents);
            
            // Total students
            const totalStudentsCard = document.createElement('div');
            totalStudentsCard.className = 'stat-card';
            totalStudentsCard.innerHTML = `
                <div class="stat-number">${classStudents.length}</div>
                <div class="stat-label">تعداد دانشجویان</div>
            `;
            statsGrid.appendChild(totalStudentsCard);
            
            // Total sessions
            const totalSessionsCard = document.createElement('div');
            totalSessionsCard.className = 'stat-card';
            totalSessionsCard.innerHTML = `
                <div class="stat-number">${classSessions.length}</div>
                <div class="stat-label">تعداد جلسات</div>
            `;
            statsGrid.appendChild(totalSessionsCard);
            
            // Average attendance
            let totalAttendance = 0;
            classSessions.forEach(session => {
                const sessionAttendance = data.attendance.filter(record => record.sessionId === session.id).length;
                totalAttendance += sessionAttendance;
            });
            
            const avgAttendance = classSessions.length > 0 ? Math.round(totalAttendance / classSessions.length) : 0;
            const avgAttendanceCard = document.createElement('div');
            avgAttendanceCard.className = 'stat-card';
            avgAttendanceCard.innerHTML = `
                <div class="stat-number">${avgAttendance}</div>
                <div class="stat-label">میانگین حضور در جلسات</div>
            `;
            statsGrid.appendChild(avgAttendanceCard);
            
            // Top student
            let topStudent = null;
            let topScore = -1;
            
            sortedStudents.forEach(student => {
                const score = calculateTotalScore(student);
                if (score > topScore) {
                    topScore = score;
                    topStudent = student;
                }
            });
            
            const topStudentCard = document.createElement('div');
            topStudentCard.className = 'stat-card';
            topStudentCard.innerHTML = `
                <div class="stat-number">${topScore}</div>
                <div class="stat-label">بالاترین امتیاز (${topStudent ? topStudent.name : '---'})</div>
            `;
            statsGrid.appendChild(topStudentCard);
            
            // Student list with scores
            const studentScoresSection = document.createElement('div');
            studentScoresSection.style.gridColumn = '1 / -1';
            studentScoresSection.style.marginTop = '30px';
            studentScoresSection.innerHTML = '<h3 style="margin-bottom: 20px; color: #2c3e50;">امتیازات دانشجویان</h3>';
            
            const studentScoresList = document.createElement('div');
            studentScoresList.className = 'students-list';
            
            sortedStudents.forEach(student => {
                const totalScore = calculateTotalScore(student);
                const studentItem = document.createElement('div');
                studentItem.className = 'student-item';
                studentItem.innerHTML = `
                    <div class="student-header">
                        <div class="student-name">${student.name}</div>
                        <div>
                            <span class="score-badge">امتیاز کل: ${totalScore}</span>
                            <button onclick="openStudentDetails('${student.id}')" class="btn btn-info">جزئیات</button>
                        </div>
                    </div>
                `;
                studentScoresList.appendChild(studentItem);
            });
            
            studentScoresSection.appendChild(studentScoresList);
            statsGrid.appendChild(studentScoresSection);
        }

        // Export to Excel
        function exportToExcel() {
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Export classes
            const classesWS = XLSX.utils.json_to_sheet(data.classes.map(cls => ({
                'شناسه': cls.id,
                'نام کلاس': cls.name,
                'توضیحات': cls.description || ''
            })));
            XLSX.utils.book_append_sheet(wb, classesWS, 'کلاس‌ها');
            
            // Export students
            const studentsWS = XLSX.utils.json_to_sheet(data.students.map(student => {
                const classInfo = data.classes.find(c => c.id === student.classId);
                return {
                    'شناسه': student.id,
                    'نام دانشجو': student.name,
                    'کلاس': classInfo ? classInfo.name : '',
                    'کد دانشجویی': student.details.code || '',
                    'شهر': student.details.city || '',
                    'رشته اصلی': student.details.major || '',
                    'رشته فرعی': student.details.minor || '',
                    'کتاب‌ها': student.details.books.map(b => `${b.title} (${b.points})`).join('، '),
                    'فیلم‌ها': student.details.movies.map(m => `${m.title} (${m.points})`).join('، '),
                    'سریال‌ها': student.details.series.map(s => `${s.title} (${s.points})`).join('، '),
                    'امتیاز کل': calculateTotalScore(student),
                    'توضیحات': student.notes || ''
                };
            }));
            XLSX.utils.book_append_sheet(wb, studentsWS, 'دانشجویان');
            
            // Export sessions
            const sessionsWS = XLSX.utils.json_to_sheet(data.sessions.map(session => {
                const classInfo = data.classes.find(c => c.id === session.classId);
                return {
                    'شناسه': session.id,
                    'عنوان جلسه': session.title,
                    'کلاس': classInfo ? classInfo.name : '',
                    'تاریخ': session.date,
                    'توضیحات': session.description || ''
                };
            }));
            XLSX.utils.book_append_sheet(wb, sessionsWS, 'جلسات');
            
            // Export attendance
            const attendanceWS = XLSX.utils.json_to_sheet(data.attendance.map(record => {
                const sessionInfo = data.sessions.find(s => s.id === record.sessionId);
                const studentInfo = data.students.find(s => s.id === record.studentId);
                const classInfo = data.classes.find(c => c.id === (sessionInfo ? sessionInfo.classId : ''));
                
                return {
                    'شناسه جلسه': record.sessionId,
                    'عنوان جلسه': sessionInfo ? sessionInfo.title : '',
                    'کلاس': classInfo ? classInfo.name : '',
                    'شناسه دانشجو': record.studentId,
                    'نام دانشجو': studentInfo ? studentInfo.name : '',
                    'تاریخ حضور': record.date
                };
            }));
            XLSX.utils.book_append_sheet(wb, attendanceWS, 'حضور و غیاب');
            
            // Export the workbook
            XLSX.writeFile(wb, 'class_manager_data.xlsx');
        }

        // Import from Excel
        function importFromExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('لطفاً یک فایل Excel انتخاب کنید.');
                return;
            }
            
            const importMode = document.querySelector('input[name="importMode"]:checked').value;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    let importedData = {
                        classes: [],
                        students: [],
                        sessions: [],
                        attendance: []
                    };
                    
                    // Import classes
                    if (workbook.Sheets['کلاس‌ها']) {
                        const classesData = XLSX.utils.sheet_to_json(workbook.Sheets['کلاس‌ها']);
                        importedData.classes = classesData.map(item => ({
                            id: item['شناسه']?.toString() || generateId(),
                            name: item['نام کلاس'] || '',
                            description: item['توضیحات'] || ''
                        }));
                    }
                    
                    // Import students
                    if (workbook.Sheets['دانشجویان']) {
                        const studentsData = XLSX.utils.sheet_to_json(workbook.Sheets['دانشجویان']);
                        importedData.students = studentsData.map(item => {
                            // Find class ID by name
                            const classInfo = importedData.classes.find(c => c.name === item['کلاس']) || 
                                            data.classes.find(c => c.name === item['کلاس']);
                            
                            return {
                                id: item['شناسه']?.toString() || generateId(),
                                classId: classInfo ? classInfo.id : '',
                                name: item['نام دانشجو'] || '',
                                notes: item['توضیحات'] || '',
                                details: {
                                    code: item['کد دانشجویی'] || '',
                                    city: item['شهر'] || '',
                                    major: item['رشته اصلی'] || '',
                                    minor: item['رشته فرعی'] || '',
                                    books: parseMediaItems(item['کتاب‌ها']),
                                    movies: parseMediaItems(item['فیلم‌ها']),
                                    series: parseMediaItems(item['سریال‌ها']),
                                    fixedScores: {
                                        isMarried: { checked: false, points: 0 },
                                        hasChild: { checked: false, points: 0 },
                                        hasJob: { checked: false, points: 0 },
                                        hasAchievement: { checked: false, points: 0 }
                                    },
                                    sessionScores: {}
                                }
                            };
                        });
                    }
                    
                    // Import sessions
                    if (workbook.Sheets['جلسات']) {
                        const sessionsData = XLSX.utils.sheet_to_json(workbook.Sheets['جلسات']);
                        importedData.sessions = sessionsData.map(item => {
                            // Find class ID by name
                            const classInfo = importedData.classes.find(c => c.name === item['کلاس']) || 
                                            data.classes.find(c => c.name === item['کلاس']);
                            
                            return {
                                id: item['شناسه']?.toString() || generateId(),
                                classId: classInfo ? classInfo.id : '',
                                title: item['عنوان جلسه'] || '',
                                date: item['تاریخ'] || '',
                                description: item['توضیحات'] || ''
                            };
                        });
                    }
                    
                    // Import attendance
                    if (workbook.Sheets['حضور و غیاب']) {
                        const attendanceData = XLSX.utils.sheet_to_json(workbook.Sheets['حضور و غیاب']);
                        importedData.attendance = attendanceData.map(item => ({
                            sessionId: item['شناسه جلسه']?.toString() || '',
                            studentId: item['شناسه دانشجو']?.toString() || '',
                            date: item['تاریخ حضور'] || new Date().toISOString()
                        })).filter(record => record.sessionId && record.studentId);
                    }
                    
                    // Apply import based on mode
                    if (importMode === 'replace') {
                        // Replace all data
                        data.classes = importedData.classes;
                        data.students = importedData.students;
                        data.sessions = importedData.sessions;
                        data.attendance = importedData.attendance;
                    } else {
                        // Merge data
                        // Merge classes
                        importedData.classes.forEach(newClass => {
                            const existingIndex = data.classes.findIndex(c => c.id === newClass.id);
                            if (existingIndex === -1) {
                                data.classes.push(newClass);
                            } else {
                                data.classes[existingIndex] = newClass;
                            }
                        });
                        
                        // Merge students
                        importedData.students.forEach(newStudent => {
                            const existingIndex = data.students.findIndex(s => s.id === newStudent.id);
                            if (existingIndex === -1) {
                                data.students.push(newStudent);
                            } else {
                                data.students[existingIndex] = newStudent;
                            }
                        });
                        
                        // Merge sessions
                        importedData.sessions.forEach(newSession => {
                            const existingIndex = data.sessions.findIndex(s => s.id === newSession.id);
                            if (existingIndex === -1) {
                                data.sessions.push(newSession);
                            } else {
                                data.sessions[existingIndex] = newSession;
                            }
                        });
                        
                        // Merge attendance
                        importedData.attendance.forEach(newAttendance => {
                            const existingIndex = data.attendance.findIndex(a => 
                                a.sessionId === newAttendance.sessionId && 
                                a.studentId === newAttendance.studentId
                            );
                            if (existingIndex === -1) {
                                data.attendance.push(newAttendance);
                            } else {
                                data.attendance[existingIndex] = newAttendance;
                            }
                        });
                    }
                    
                    saveData();
                    closeModal('excelImportModal');
                    init();
                    alert('اطلاعات با موفقیت وارد شد.');
                    
                } catch (error) {
                    console.error('Error importing Excel file:', error);
                    alert('خطا در وارد کردن فایل Excel. لطفاً مطمئن شوید فایل معتبر است.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Helper function to parse media items from string
        function parseMediaItems(itemsString) {
            if (!itemsString) return [];
            
            try {
                return itemsString.split('،').map(item => {
                    const match = item.trim().match(/(.+)\((\d+)\)/);
                    if (match) {
                        return {
                            title: match[1].trim(),
                            points: parseInt(match[2]) || 0
                        };
                    }
                    return {
                        title: item.trim(),
                        points: 0
                    };
                }).filter(item => item.title);
            } catch (error) {
                return [];
            }
        }

        // Helper function to generate ID
        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 5);
        }

        // Open modal
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Open export modal
        function openExportModal() {
            document.getElementById('exportData').value = JSON.stringify(data, null, 2);
            openModal('exportModal');
        }

        // Copy export data
        function copyExportData() {
            const exportData = document.getElementById('exportData');
            exportData.select();
            document.execCommand('copy');
            alert('اطلاعات کپی شد.');
        }

        // Open import modal
        function openImportModal() {
            document.getElementById('importData').value = '';
            openModal('importModal');
        }

        // Open Excel import modal
        function openExcelImportModal() {
            document.getElementById('excelFile').value = '';
            openModal('excelImportModal');
        }

        // Import from JSON
        function importFromJSON() {
            const importData = document.getElementById('importData').value;
            
            if (!importData.trim()) {
                alert('لطفاً اطلاعات JSON را وارد کنید.');
                return;
            }
            
            try {
                const parsedData = JSON.parse(importData);
                
                // Validate data structure
                if (parsedData.classes && parsedData.students && parsedData.sessions && parsedData.attendance) {
                    data = parsedData;
                    saveData();
                    closeModal('importModal');
                    init();
                    alert('اطلاعات با موفقیت وارد شد.');
                } else {
                    alert('فرمت JSON نامعتبر است. لطفاً مطمئن شوید که فایل شامل کلاس‌ها، دانشجویان، جلسات و حضور و غیاب است.');
                }
            } catch (error) {
                alert('خطا در تجزیه JSON. لطفاً مطمئن شوید که فرمت صحیح است.');
            }
        }

        // Reset all data
        function resetData() {
            if (confirm('آیا از بازنشانی همه اطلاعات مطمئن هستید؟ این عمل غیرقابل بازگشت است.')) {
                data = {
                    classes: [],
                    students: [],
                    sessions: [],
                    attendance: []
                };
                saveData();
                init();
                alert('همه اطلاعات بازنشانی شد.');
            }
        }

        // Initialize the app
        window.onload = init;
    </script>
</body>
</html>
