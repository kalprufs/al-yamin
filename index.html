<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استادیار - سیستم مدیریت حضور و غیاب کلاس</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        @font-face {
            font-family: 'AbarLowFaNum';
            src: url('otf/AbarLowFaNum-Regular.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        body {
            font-family: 'AbarLowFaNum', 'Vazirmatn', 'Tahoma', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            direction: rtl;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            font-weight: 300;
            opacity: 0.9;
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.1);
        }
        
        .tabs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 30px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            padding: 8px;
            gap: 8px;
        }
        
        .tab {
            flex: 1 1 auto;
            min-width: 120px;
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            font-family: inherit;
            border-radius: 12px;
            transition: all 0.3s ease;
            color: #666;
            white-space: nowrap;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .tab:hover:not(.active) {
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(20px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }
        
        .tab-content h2 {
            font-size: 1.8em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 12px;
            border-bottom: 3px solid #667eea;
        }
        
        .class-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .class-selector label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .class-selector select {
            padding: 10px 15px;
            border: 2px solid #e3f2fd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            min-width: 200px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e3f2fd;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }
        
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.3s ease;
            margin: 6px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(40, 167, 69, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #e91e63);
            color: white;
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(220, 53, 69, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #6f42c1);
            color: white;
            box-shadow: 0 8px 20px rgba(23, 162, 184, 0.3);
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(23, 162, 184, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(255, 193, 7, 0.4);
        }
        
        .sessions-list, .students-list, .classes-list {
            margin-top: 25px;
        }
        
        .session-item, .student-item, .class-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-right: 4px solid #667eea;
        }
        
        .session-item:hover, .student-item:hover, .class-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .session-header, .student-header, .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .session-title, .student-name, .class-name {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .session-item p, .student-item p, .class-item p {
            color: #5a6c7d;
            line-height: 1.6;
            margin: 6px 0;
        }
        
        .session-item p strong, .student-item p strong, .class-item p strong {
            color: #2c3e50;
            font-weight: 600;
        }
        
        .attendance-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .attendance-item {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.95));
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            gap: 12px;
        }
        
        .attendance-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .attendance-item input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: #667eea;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .student-name-clickable {
            cursor: pointer;
            color: #667eea;
            font-weight: 500;
            flex-grow: 1;
            transition: all 0.3s ease;
            padding: 4px 8px;
            border-radius: 6px;
            user-select: none;
        }
        
        .student-name-clickable:hover {
            color: #5a6fd8;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .score-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-left: 12px;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.95));
            margin: 3% auto;
            padding: 35px;
            border-radius: 20px;
            width: 90%;
            max-width: 850px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
            position: relative;
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }
        
        .close {
            position: absolute;
            left: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            transition: all 0.3s ease;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.8);
        }
        
        .close:hover {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            transform: rotate(90deg);
        }
        
        .modal h2 {
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 2em;
            font-weight: 700;
            border-bottom: 3px solid #667eea;
            padding-bottom: 12px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0;
            padding: 12px 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #d1d5db;
        }
        
        .checkbox-group:hover {
            border-color: #667eea;
        }
        
        .checkbox-group input[type="checkbox"] {
            order: 2;
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }
        
        .checkbox-group label {
            font-weight: 500;
            color: #000000;
            cursor: pointer;
            order: 1;
        }
        
        .dynamic-list {
            border: 2px solid rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            padding: 18px;
            margin: 12px 0;
            background: rgba(255,255,255,0.4);
        }
        
        .dynamic-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            padding: 12px;
            background: rgba(255,255,255,0.7);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            gap: 10px;
        }
        
        .dynamic-item input {
            flex: 1;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        .score-display {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 18px;
            border-radius: 12px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }
        
        .export-section {
            text-align: center;
            margin: 35px 0;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .export-section h3 {
            font-size: 1.6em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 18px;
        }
        
        .json-section {
            margin: 25px 0;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .json-section h3 {
            font-size: 1.6em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 18px;
        }
        
        .json-section textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e3f2fd;
            border-radius: 12px;
            font-family: monospace;
            font-size: 14px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.8);
        }
        
        .json-section .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-6px) scale(1.03);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .stat-label {
            font-size: 0.95em;
            font-weight: 500;
            margin-top: 8px;
            opacity: 0.9;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 50px 20px;
            background: rgba(255,255,255,0.5);
            border-radius: 12px;
            border: 2px dashed rgba(153,153,153,0.3);
        }
        
        .bulk-add-section {
            margin-top: 18px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .bulk-add-section h3 {
            margin-bottom: 12px;
            color: #2c3e50;
        }
        
        .bulk-add-section p {
            color: #666;
            margin-bottom: 12px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #17a2b8, #6f42c1);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 6px;
        }
        
        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(23, 162, 184, 0.4);
        }
        
        .json-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .main-content {
                padding: 20px 15px;
                border-radius: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 0.95em;
            }
            
            .tabs {
                padding: 6px;
            }
            
            .tab {
                min-width: calc(50% - 8px);
                padding: 12px 15px;
                font-size: 13px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .attendance-list {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .stat-number {
                font-size: 2em;
            }
            
            .modal-content {
                width: 95%;
                margin: 3% auto;
                padding: 25px 18px;
            }
            
            .session-header, .student-header, .class-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .btn {
                padding: 10px 18px;
                font-size: 13px;
                margin: 4px;
            }
            
            .class-selector {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .class-selector select {
                min-width: 100%;
            }
            
            .json-section .btn-group {
                flex-direction: column;
            }
            
            .json-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>استادیار</h1>
            <p>مدیریت کامل کلاس‌ها، جلسات، دانشجویان و امتیازدهی</p>
        </div>
        
        <div class="main-content">
            <div class="tabs">
                <button class="tab" onclick="showTab('classes')">کلاس‌ها</button>
                <button class="tab active" onclick="showTab('sessions')">جلسات</button>
                <button class="tab" onclick="showTab('students')">دانشجویان</button>
                <button class="tab" onclick="showTab('attendance')">حضور و غیاب</button>
                <button class="tab" onclick="showTab('reports')">گزارشات</button>
            </div>
            
            <div id="classes" class="tab-content">
                <h2>مدیریت کلاس‌ها</h2>
                <form id="classForm">
                    <div class="form-group">
                        <label>نام کلاس:</label>
                        <input type="text" id="className" required>
                    </div>
                    <div class="form-group">
                        <label>توضیحات:</label>
                        <textarea id="classDescription" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">افزودن کلاس</button>
                </form>
                
                <div class="classes-list" id="classesList"></div>
                
                <!-- بخش وارد کردن JSON -->
                <div class="json-section">
                    <h3>مدیریت داده‌ها</h3>
                    <p style="margin-bottom: 15px; color: #666;">می‌توانید اطلاعات را وارد یا خارج کنید:</p>
                    
                    <div class="json-buttons">
                        <button onclick="openImportModal()" class="btn btn-info">وارد کردن اطلاعات از JSON</button>
                        <button onclick="resetData()" class="btn btn-danger">بازنشانی همه اطلاعات</button>
                    </div>
                </div>
            </div>
            
            <div id="sessions" class="tab-content active">
                <h2>مدیریت جلسات</h2>
                <div class="class-selector">
                    <label>انتخاب کلاس:</label>
                    <select id="sessionClass" onchange="renderSessions()">
                        <option value="">-- انتخاب کنید --</option>
                    </select>
                </div>
                <form id="sessionForm">
                    <div class="form-group">
                        <label>عنوان جلسه:</label>
                        <input type="text" id="sessionTitle" required>
                    </div>
                    <div class="form-group">
                        <label>تاریخ جلسه (شمسی):</label>
                        <input type="text" id="sessionDate" placeholder="مثال: 1403/07/12" required>
                    </div>
                    <div class="form-group">
                        <label>توضیحات:</label>
                        <textarea id="sessionDescription" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">افزودن جلسه</button>
                </form>
                
                <div class="sessions-list" id="sessionsList"></div>
            </div>
            
            <div id="students" class="tab-content">
                <h2>مدیریت دانشجویان</h2>
                <div class="class-selector">
                    <label>انتخاب کلاس:</label>
                    <select id="studentClass" onchange="renderStudents()">
                        <option value="">-- انتخاب کنید --</option>
                    </select>
                </div>
                <form id="studentForm">
                    <div class="form-group">
                        <label>نام دانشجو:</label>
                        <input type="text" id="studentName" required>
                    </div>
                    <div class="form-group">
                        <label>توضیحات کلی:</label>
                        <textarea id="studentNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">افزودن دانشجو</button>
                    <button type="button" onclick="toggleBulkAdd()" class="btn btn-info">افزودن گروهی</button>
                    <button type="button" onclick="importFromExcel()" class="btn btn-warning">ورود از اکسل</button>
                    <button type="button" onclick="deleteAllStudents()" class="btn btn-danger">حذف همه دانشجویان</button>
                </form>
                
                <div id="bulkAddSection" class="bulk-add-section" style="display: none;">
                    <h3>افزودن چند دانشجو به صورت همزمان</h3>
                    <p>هر نام را در یک خط جداگانه وارد کنید:</p>
                    <textarea id="bulkStudentNames" rows="8" placeholder="دانشجو ۱&#10;دانشجو ۲&#10;دانشجو ۳&#10;..." style="width: 100%; padding: 14px 18px; border: 2px solid #e3f2fd; border-radius: 12px; font-size: 14px; font-family: inherit; background: rgba(255, 255, 255, 0.8);"></textarea>
                    <div style="margin-top: 12px;">
                        <button type="button" onclick="addBulkStudents()" class="btn btn-success">افزودن همه</button>
                        <button type="button" onclick="toggleBulkAdd()" class="btn btn-danger">انصراف</button>
                    </div>
                </div>
                
                <div class="students-list" id="studentsList"></div>
            </div>
            
            <div id="attendance" class="tab-content">
                <h2>حضور و غیاب</h2>
                <div class="class-selector">
                    <label>انتخاب کلاس:</label>
                    <select id="attendanceClass" onchange="renderAttendance()">
                        <option value="">-- انتخاب کنید --</option>
                    </select>
                </div>
                <div id="attendanceContent"></div>
            </div>
            
            <div id="reports" class="tab-content">
                <h2>گزارشات و آمار</h2>
                <div class="class-selector">
                    <label>انتخاب کلاس:</label>
                    <select id="reportClass" onchange="renderStats()">
                        <option value="">-- انتخاب کنید --</option>
                    </select>
                </div>
                <div class="stats-grid" id="statsGrid"></div>
                
                <div class="export-section">
                    <h3>خروجی داده‌ها</h3>
                    <p style="margin-bottom: 18px; color: #666;">تمام اطلاعات را در قالب فایل Excel دریافت کنید</p>
                    <button onclick="exportToExcel()" class="btn btn-success">دانلود فایل Excel</button>
                </div>
                
                <!-- بخش خروجی JSON -->
                <div class="json-section">
                    <h3>خروجی گرفتن اطلاعات</h3>
                    <p style="margin-bottom: 15px; color: #666;">می‌توانید تمام اطلاعات را به صورت JSON ذخیره کنید:</p>
                    
                    <div class="json-buttons">
                        <button onclick="openExportModal()" class="btn btn-warning">خروجی JSON</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- مودال جزئیات دانشجو -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('studentModal')">&times;</span>
            <h2>جزئیات دانشجو</h2>
            <form id="studentDetailsForm">
                <input type="hidden" id="modalStudentId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>نام دانشجو:</label>
                        <input type="text" id="modalStudentName" readonly>
                    </div>
                    <div class="form-group">
                        <label>کد دانشجویی:</label>
                        <input type="text" id="modalStudentCode">
                    </div>
                    <div class="form-group">
                        <label>شهر محل زندگی:</label>
                        <input type="text" id="modalCity">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>رشته اصلی:</label>
                        <input type="text" id="modalMajor">
                    </div>
                    <div class="form-group">
                        <label>رشته فرعی:</label>
                        <input type="text" id="modalMinor">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>کتاب‌های مطالعه‌شده:</label>
                    <div class="dynamic-list" id="booksList">
                        <button type="button" onclick="addBook()" class="btn btn-info">+ افزودن کتاب</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>فیلم‌های دیده‌شده:</label>
                    <div class="dynamic-list" id="moviesList">
                        <button type="button" onclick="addMovie()" class="btn btn-info">+ افزودن فیلم</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>سریال‌های دیده‌شده:</label>
                    <div class="dynamic-list" id="seriesList">
                        <button type="button" onclick="addSeries()" class="btn btn-info">+ افزودن سریال</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>وضعیت امتیازات ثابت:</label>
                    <div class="checkbox-group">
                        <label>متأهل</label>
                        <input type="checkbox" id="modalIsMarried">
                        <input type="number" id="modalIsMarriedPoints" placeholder="امتیاز" style="width: 80px; margin-right: 10px;">
                    </div>
                    <div class="checkbox-group">
                        <label>داشتن فرزند</label>
                        <input type="checkbox" id="modalHasChild">
                        <input type="number" id="modalHasChildPoints" placeholder="امتیاز" style="width: 80px; margin-right: 10px;">
                    </div>
                    <div class="checkbox-group">
                        <label>داشتن شغل</label>
                        <input type="checkbox" id="modalHasJob">
                        <input type="number" id="modalHasJobPoints" placeholder="امتیاز" style="width: 80px; margin-right: 10px;">
                    </div>
                    <div class="checkbox-group">
                        <label>داشتن مقام یا قهرمانی</label>
                        <input type="checkbox" id="modalHasAchievement">
                        <input type="number" id="modalHasAchievementPoints" placeholder="امتیاز" style="width: 80px; margin-right: 10px;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>امتیازات این جلسه:</label>
                    <div id="currentSessionScores"></div>
                </div>
                
                <div class="form-group">
                    <label>امتیازات دلخواه این جلسه:</label>
                    <div class="dynamic-list" id="customSessionScores">
                        <button type="button" onclick="addCustomScore()" class="btn btn-info">+ افزودن امتیاز دلخواه</button>
                    </div>
                </div>
                
                <div class="score-display" id="totalScoreDisplay">امتیاز کل: 0</div>
                
                <div class="form-group">
                    <label>یادداشت‌ها:</label>
                    <textarea id="modalNotes" rows="4"></textarea>
                </div>
                
                <button type="button" onclick="saveStudentDetails()" class="btn btn-success">ذخیره تغییرات</button>
            </form>
        </div>
    </div>
    
    <!-- مودال وارد کردن JSON -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('importModal')">&times;</span>
            <h2>وارد کردن اطلاعات از JSON</h2>
            <p style="margin-bottom: 15px; color: #666;">اطلاعات JSON را در کادر زیر وارد کنید:</p>
            <textarea id="importJson" rows="15" style="width: 100%; padding: 15px; border: 2px solid #e3f2fd; border-radius: 12px; font-family: monospace; font-size: 14px; background: rgba(255, 255, 255, 0.8);"></textarea>
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="importFromJson()" class="btn btn-success">وارد کردن اطلاعات</button>
                <button onclick="closeModal('importModal')" class="btn btn-danger">انصراف</button>
            </div>
        </div>
    </div>
    
    <!-- مودال خروجی JSON -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('exportModal')">&times;</span>
            <h2>خروجی گرفتن اطلاعات به صورت JSON</h2>
            <p style="margin-bottom: 15px; color: #666;">می‌توانید تمام اطلاعات را کپی کرده و ذخیره کنید:</p>
            <textarea id="exportJson" rows="15" style="width: 100%; padding: 15px; border: 2px solid #e3f2fd; border-radius: 12px; font-family: monospace; font-size: 14px; background: rgba(255, 255, 255, 0.8);" readonly></textarea>
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="copyToClipboard()" class="btn btn-success">کپی به کلیپ‌بورد</button>
                <button onclick="closeModal('exportModal')" class="btn btn-danger">بستن</button>
            </div>
        </div>
    </div>
    
    <!-- ورودی فایل اکسل -->
    <input type="file" id="excelFileInput" class="file-input" accept=".xlsx, .xls">
    
    <script>
        // داده‌های اولیه
        let classes = JSON.parse(localStorage.getItem('classes')) || [];
        let students = JSON.parse(localStorage.getItem('students')) || [];
        let sessions = JSON.parse(localStorage.getItem('sessions')) || [];
        let attendance = JSON.parse(localStorage.getItem('attendance')) || [];
        
        // تابع برای مرتب‌سازی اسامی بر اساس الفبای فارسی
        function sortPersianNames(names) {
            return names.sort((a, b) => {
                return a.localeCompare(b, 'fa');
            });
        }
        
        // تابع برای ذخیره داده‌ها در localStorage
        function saveData() {
            localStorage.setItem('classes', JSON.stringify(classes));
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem('sessions', JSON.stringify(sessions));
            localStorage.setItem('attendance', JSON.stringify(attendance));
        }
        
        // تابع برای نمایش تب‌ها
        function showTab(tabName) {
            // مخفی کردن همه تب‌ها
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // غیرفعال کردن همه دکمه‌های تب
            const tabs = document.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // نمایش تب انتخاب شده
            document.getElementById(tabName).classList.add('active');
            
            // پیدا کردن دکمه تب مربوطه و فعال کردن آن
            const tabButtons = document.getElementsByClassName('tab');
            for (let i = 0; i < tabButtons.length; i++) {
                if (tabButtons[i].textContent.trim() === getTabName(tabName)) {
                    tabButtons[i].classList.add('active');
                    break;
                }
            }
            
            // رندر کردن محتوای تب
            if (tabName === 'classes') {
                renderClasses();
            } else if (tabName === 'sessions') {
                renderClassSelectors();
                renderSessions();
            } else if (tabName === 'students') {
                renderClassSelectors();
                renderStudents();
            } else if (tabName === 'attendance') {
                renderClassSelectors();
                renderAttendance();
            } else if (tabName === 'reports') {
                renderClassSelectors();
                renderStats();
            }
        }
        
        // تابع برای دریافت نام فارسی تب
        function getTabName(tabId) {
            const tabNames = {
                'classes': 'کلاس‌ها',
                'sessions': 'جلسات',
                'students': 'دانشجویان',
                'attendance': 'حضور و غیاب',
                'reports': 'گزارشات'
            };
            return tabNames[tabId] || tabId;
        }
        
        // تابع برای رندر کردن کلاس‌ها
        function renderClasses() {
            const classesList = document.getElementById('classesList');
            
            if (classes.length === 0) {
                classesList.innerHTML = '<div class="empty-state">هنوز کلاسی اضافه نشده است.</div>';
                return;
            }
            
            let html = '';
            classes.forEach((cls, index) => {
                html += `
                <div class="class-item">
                    <div class="class-header">
                        <div class="class-name">${cls.name}</div>
                        <div>
                            <button onclick="editClass(${index})" class="btn btn-warning">ویرایش</button>
                            <button onclick="deleteClass(${index})" class="btn btn-danger">حذف</button>
                        </div>
                    </div>
                    <p><strong>توضیحات:</strong> ${cls.description || 'بدون توضیحات'}</p>
                    <p><strong>تعداد دانشجویان:</strong> ${students.filter(s => s.classId === cls.id).length}</p>
                    <p><strong>تعداد جلسات:</strong> ${sessions.filter(s => s.classId === cls.id).length}</p>
                </div>
                `;
            });
            
            classesList.innerHTML = html;
        }
        
        // تابع برای رندر کردن جلسات
        function renderSessions() {
            const sessionsList = document.getElementById('sessionsList');
            const classId = document.getElementById('sessionClass').value;
            
            if (!classId) {
                sessionsList.innerHTML = '<div class="empty-state">لطفاً یک کلاس انتخاب کنید.</div>';
                return;
            }
            
            const classSessions = sessions.filter(s => s.classId === classId);
            
            if (classSessions.length === 0) {
                sessionsList.innerHTML = '<div class="empty-state">هنوز جلسه‌ای برای این کلاس اضافه نشده است.</div>';
                return;
            }
            
            let html = '';
            classSessions.forEach((session, index) => {
                html += `
                <div class="session-item">
                    <div class="session-header">
                        <div class="session-title">${session.title}</div>
                        <div>
                            <button onclick="editSession(${index})" class="btn btn-warning">ویرایش</button>
                            <button onclick="deleteSession(${index})" class="btn btn-danger">حذف</button>
                        </div>
                    </div>
                    <p><strong>تاریخ:</strong> ${session.date}</p>
                    <p><strong>توضیحات:</strong> ${session.description || 'بدون توضیحات'}</p>
                </div>
                `;
            });
            
            sessionsList.innerHTML = html;
        }
        
        // تابع برای رندر کردن دانشجویان
        function renderStudents() {
            const studentsList = document.getElementById('studentsList');
            const classId = document.getElementById('studentClass').value;
            
            if (!classId) {
                studentsList.innerHTML = '<div class="empty-state">لطفاً یک کلاس انتخاب کنید.</div>';
                return;
            }
            
            const classStudents = students.filter(s => s.classId === classId);
            
            if (classStudents.length === 0) {
                studentsList.innerHTML = '<div class="empty-state">هنوز دانشجویی برای این کلاس اضافه نشده است.</div>';
                return;
            }
            
            // مرتب‌سازی اسامی بر اساس الفبای فارسی
            const sortedStudents = sortPersianNames(classStudents.map(s => s.name)).map(name => 
                classStudents.find(s => s.name === name)
            );
            
            let html = '';
            sortedStudents.forEach((student, index) => {
                const studentIndex = students.findIndex(s => s.id === student.id);
                const totalScore = calculateTotalScore(student);
                
                html += `
                <div class="student-item">
                    <div class="student-header">
                        <div class="student-name">${student.name}</div>
                        <div>
                            <span class="score-badge">${totalScore} امتیاز</span>
                            <button onclick="openStudentModal(${studentIndex})" class="btn btn-info">جزئیات</button>
                            <button onclick="deleteStudent(${studentIndex})" class="btn btn-danger">حذف</button>
                        </div>
                    </div>
                    <p><strong>یادداشت‌ها:</strong> ${student.notes || 'بدون یادداشت'}</p>
                </div>
                `;
            });
            
            studentsList.innerHTML = html;
        }
        
        // تابع برای رندر کردن حضور و غیاب
        function renderAttendance() {
            const attendanceContent = document.getElementById('attendanceContent');
            const classId = document.getElementById('attendanceClass').value;
            
            if (!classId) {
                attendanceContent.innerHTML = '<div class="empty-state">لطفاً یک کلاس انتخاب کنید.</div>';
                return;
            }
            
            const classStudents = students.filter(s => s.classId === classId);
            const classSessions = sessions.filter(s => s.classId === classId);
            
            if (classStudents.length === 0) {
                attendanceContent.innerHTML = '<div class="empty-state">هنوز دانشجویی برای این کلاس اضافه نشده است.</div>';
                return;
            }
            
            if (classSessions.length === 0) {
                attendanceContent.innerHTML = '<div class="empty-state">هنوز جلسه‌ای برای این کلاس اضافه نشده است.</div>';
                return;
            }
            
            // مرتب‌سازی اسامی بر اساس الفبای فارسی
            const sortedStudents = sortPersianNames(classStudents.map(s => s.name)).map(name => 
                classStudents.find(s => s.name === name)
            );
            
            let html = '<h3 style="margin-bottom: 20px;">ثبت حضور و غیاب</h3>';
            
            // انتخاب جلسه
            html += `
            <div class="form-group">
                <label>انتخاب جلسه:</label>
                <select id="attendanceSession" onchange="renderAttendanceList()" style="margin-bottom: 20px;">
                    <option value="">-- انتخاب کنید --</option>
                    ${classSessions.map(session => `<option value="${session.id}">${session.title} (${session.date})</option>`).join('')}
                </select>
            </div>
            `;
            
            html += '<div id="attendanceList"></div>';
            
            attendanceContent.innerHTML = html;
        }
        
        // تابع برای رندر لیست حضور و غیاب
        function renderAttendanceList() {
            const attendanceList = document.getElementById('attendanceList');
            const sessionId = document.getElementById('attendanceSession').value;
            const classId = document.getElementById('attendanceClass').value;
            
            if (!sessionId) {
                attendanceList.innerHTML = '';
                return;
            }
            
            const classStudents = students.filter(s => s.classId === classId);
            
            // مرتب‌سازی اسامی بر اساس الفبای فارسی
            const sortedStudents = sortPersianNames(classStudents.map(s => s.name)).map(name => 
                classStudents.find(s => s.name === name)
            );
            
            let html = '<div class="attendance-list">';
            
            sortedStudents.forEach(student => {
                const isPresent = attendance.some(a => a.studentId === student.id && a.sessionId === sessionId);
                
                html += `
                <div class="attendance-item">
                    <input type="checkbox" id="attendance_${student.id}" ${isPresent ? 'checked' : ''} onchange="updateAttendance('${student.id}', '${sessionId}', this.checked)">
                    <label for="attendance_${student.id}" class="student-name-clickable" onclick="openStudentModal(${students.findIndex(s => s.id === student.id)})">${student.name}</label>
                </div>
                `;
            });
            
            html += '</div>';
            
            attendanceList.innerHTML = html;
        }
        
        // تابع برای رندر آمار و گزارشات
        function renderStats() {
            const statsGrid = document.getElementById('statsGrid');
            const classId = document.getElementById('reportClass').value;
            
            if (!classId) {
                statsGrid.innerHTML = '<div class="empty-state">لطفاً یک کلاس انتخاب کنید.</div>';
                return;
            }
            
            const classStudents = students.filter(s => s.classId === classId);
            const classSessions = sessions.filter(s => s.classId === classId);
            
            if (classStudents.length === 0) {
                statsGrid.innerHTML = '<div class="empty-state">هنوز دانشجویی برای این کلاس اضافه نشده است.</div>';
                return;
            }
            
            // محاسبه آمار
            const totalStudents = classStudents.length;
            const totalSessions = classSessions.length;
            
            // محاسبه میانگین امتیاز
            let totalScoreSum = 0;
            classStudents.forEach(student => {
                totalScoreSum += calculateTotalScore(student);
            });
            const averageScore = totalScoreSum / totalStudents;
            
            // محاسبه تعداد حضورها
            let totalAttendances = 0;
            classSessions.forEach(session => {
                totalAttendances += attendance.filter(a => a.sessionId === session.id).length;
            });
            
            // محاسبه میانگین حضور
            const averageAttendance = totalAttendances / totalSessions;
            
            let html = `
            <div class="stat-card">
                <div class="stat-number">${totalStudents}</div>
                <div class="stat-label">تعداد دانشجویان</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${totalSessions}</div>
                <div class="stat-label">تعداد جلسات</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${averageScore.toFixed(1)}</div>
                <div class="stat-label">میانگین امتیاز</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${averageAttendance.toFixed(1)}</div>
                <div class="stat-label">میانگین حضور</div>
            </div>
            `;
            
            statsGrid.innerHTML = html;
        }
        
        // تابع برای رندر کردن انتخاب‌گرهای کلاس
        function renderClassSelectors() {
            const classSelectors = document.querySelectorAll('select[id$="Class"]');
            
            classSelectors.forEach(selector => {
                let html = '<option value="">-- انتخاب کنید --</option>';
                
                classes.forEach(cls => {
                    html += `<option value="${cls.id}">${cls.name}</option>`;
                });
                
                selector.innerHTML = html;
            });
        }
        
        // تابع برای محاسبه امتیاز کل دانشجو
        function calculateTotalScore(student) {
            let totalScore = 0;
            
            // امتیازات ثابت
            if (student.isMarried) totalScore += student.isMarriedPoints || 0;
            if (student.hasChild) totalScore += student.hasChildPoints || 0;
            if (student.hasJob) totalScore += student.hasJobPoints || 0;
            if (student.hasAchievement) totalScore += student.hasAchievementPoints || 0;
            
            // امتیازات جلسات
            if (student.sessionScores) {
                Object.values(student.sessionScores).forEach(score => {
                    totalScore += score;
                });
            }
            
            // امتیازات دلخواه جلسات
            if (student.customSessionScores) {
                Object.values(student.customSessionScores).forEach(score => {
                    totalScore += score;
                });
            }
            
            return totalScore;
        }
        
        // تابع برای باز کردن مودال جزئیات دانشجو
        function openStudentModal(studentIndex) {
            const student = students[studentIndex];
            document.getElementById('modalStudentId').value = studentIndex;
            document.getElementById('modalStudentName').value = student.name;
            document.getElementById('modalStudentCode').value = student.studentCode || '';
            document.getElementById('modalCity').value = student.city || '';
            document.getElementById('modalMajor').value = student.major || '';
            document.getElementById('modalMinor').value = student.minor || '';
            document.getElementById('modalNotes').value = student.notes || '';
            
            // تنظیم وضعیت امتیازات ثابت
            document.getElementById('modalIsMarried').checked = student.isMarried || false;
            document.getElementById('modalIsMarriedPoints').value = student.isMarriedPoints || '';
            document.getElementById('modalHasChild').checked = student.hasChild || false;
            document.getElementById('modalHasChildPoints').value = student.hasChildPoints || '';
            document.getElementById('modalHasJob').checked = student.hasJob || false;
            document.getElementById('modalHasJobPoints').value = student.hasJobPoints || '';
            document.getElementById('modalHasAchievement').checked = student.hasAchievement || false;
            document.getElementById('modalHasAchievementPoints').value = student.hasAchievementPoints || '';
            
            // رندر کردن کتاب‌ها
            const booksList = document.getElementById('booksList');
            booksList.innerHTML = '<button type="button" onclick="addBook()" class="btn btn-info">+ افزودن کتاب</button>';
            
            if (student.books && student.books.length > 0) {
                student.books.forEach((book, index) => {
                    booksList.innerHTML += `
                    <div class="dynamic-item">
                        <input type="text" value="${book}" onchange="updateStudentProperty('books', ${index}, this.value)" placeholder="نام کتاب">
                        <button type="button" onclick="removeBook(${index})" class="btn btn-danger">حذف</button>
                    </div>
                    `;
                });
            }
            
            // رندر کردن فیلم‌ها
            const moviesList = document.getElementById('moviesList');
            moviesList.innerHTML = '<button type="button" onclick="addMovie()" class="btn btn-info">+ افزودن فیلم</button>';
            
            if (student.movies && student.movies.length > 0) {
                student.movies.forEach((movie, index) => {
                    moviesList.innerHTML += `
                    <div class="dynamic-item">
                        <input type="text" value="${movie}" onchange="updateStudentProperty('movies', ${index}, this.value)" placeholder="نام فیلم">
                        <button type="button" onclick="removeMovie(${index})" class="btn btn-danger">حذف</button>
                    </div>
                    `;
                });
            }
            
            // رندر کردن سریال‌ها
            const seriesList = document.getElementById('seriesList');
            seriesList.innerHTML = '<button type="button" onclick="addSeries()" class="btn btn-info">+ افزودن سریال</button>';
            
            if (student.series && student.series.length > 0) {
                student.series.forEach((series, index) => {
                    seriesList.innerHTML += `
                    <div class="dynamic-item">
                        <input type="text" value="${series}" onchange="updateStudentProperty('series', ${index}, this.value)" placeholder="نام سریال">
                        <button type="button" onclick="removeSeries(${index})" class="btn btn-danger">حذف</button>
                    </div>
                    `;
                });
            }
            
            // رندر کردن امتیازات دلخواه جلسات
            const customSessionScores = document.getElementById('customSessionScores');
            customSessionScores.innerHTML = '<button type="button" onclick="addCustomScore()" class="btn btn-info">+ افزودن امتیاز دلخواه</button>';
            
            if (student.customSessionScores) {
                Object.keys(student.customSessionScores).forEach(key => {
                    customSessionScores.innerHTML += `
                    <div class="dynamic-item">
                        <input type="text" value="${key}" onchange="updateCustomSessionScoreKey('${key}', this.value)" placeholder="عنوان امتیاز">
                        <input type="number" value="${student.customSessionScores[key]}" onchange="updateCustomSessionScoreValue('${key}', this.value)" placeholder="امتیاز">
                        <button type="button" onclick="removeCustomSessionScore('${key}')" class="btn btn-danger">حذف</button>
                    </div>
                    `;
                });
            }
            
            // به‌روزرسانی نمایش امتیاز کل
            updateTotalScoreDisplay();
            
            // نمایش مودال
            document.getElementById('studentModal').style.display = 'block';
        }
        
        // تابع برای بستن مودال
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // تابع برای افزودن کتاب
        function addBook() {
            const studentIndex = document.getElementById('modalStudentId').value;
            if (!students[studentIndex].books) {
                students[studentIndex].books = [];
            }
            students[studentIndex].books.push('');
            saveData();
            openStudentModal(parseInt(studentIndex));
        }
        
        // تابع برای حذف کتاب
        function removeBook(index) {
            const studentIndex = document.getElementById('modalStudentId').value;
            students[studentIndex].books.splice(index, 1);
            saveData();
            openStudentModal(parseInt(studentIndex));
        }
        
        // تابع برای افزودن فیلم
        function addMovie() {
            const studentIndex = document.getElementById('modalStudentId').value;
            if (!students[studentIndex].movies) {
                students[studentIndex].movies = [];
            }
            students[studentIndex].movies.push('');
            saveData();
            openStudentModal(parseInt(studentIndex));
        }
        
        // تابع برای حذف فیلم
        function removeMovie(index) {
            const studentIndex = document.getElementById('modalStudentId').value;
            students[studentIndex].movies.splice(index, 1);
            saveData();
            openStudentModal(parseInt(studentIndex));
        }
        
        // تابع برای افزودن سریال
        function addSeries() {
            const studentIndex = document.getElementById('modalStudentId').value;
            if (!students[studentIndex].series) {
                students[studentIndex].series = [];
            }
            students[studentIndex].series.push('');
            saveData();
            openStudentModal(parseInt(studentIndex));
        }
        
        // تابع برای حذف سریال
        function removeSeries(index) {
            const studentIndex = document.getElementById('modalStudentId').value;
            students[studentIndex].series.splice(index, 1);
            saveData();
            openStudentModal(parseInt(studentIndex));
        }
        
        // تابع برای افزودن امتیاز دلخواه
        function addCustomScore() {
            const studentIndex = document.getElementById('modalStudentId').value;
            if (!students[studentIndex].customSessionScores) {
                students[studentIndex].customSessionScores = {};
            }
            const key = `امتیاز دلخواه ${Object.keys(students[studentIndex].customSessionScores).length + 1}`;
            students[studentIndex].customSessionScores[key] = 0;
            saveData();
            openStudentModal(parseInt(studentIndex));
        }
        
        // تابع برای به‌روزرسانی کلید امتیاز دلخواه
        function updateCustomSessionScoreKey(oldKey, newKey) {
            const studentIndex = document.getElementById('modalStudentId').value;
            if (students[studentIndex].customSessionScores[oldKey] !== undefined) {
                students[studentIndex].customSessionScores[newKey] = students[studentIndex].customSessionScores[oldKey];
                delete students[studentIndex].customSessionScores[oldKey];
                saveData();
            }
        }
        
        // تابع برای به‌روزرسانی مقدار امتیاز دلخواه
        function updateCustomSessionScoreValue(key, value) {
            const studentIndex = document.getElementById('modalStudentId').value;
            students[studentIndex].customSessionScores[key] = parseInt(value) || 0;
            saveData();
            updateTotalScoreDisplay();
        }
        
        // تابع برای حذف امتیاز دلخواه
        function removeCustomSessionScore(key) {
            const studentIndex = document.getElementById('modalStudentId').value;
            delete students[studentIndex].customSessionScores[key];
            saveData();
            openStudentModal(parseInt(studentIndex));
        }
        
        // تابع برای به‌روزرسانی ویژگی دانشجو
        function updateStudentProperty(property, index, value) {
            const studentIndex = document.getElementById('modalStudentId').value;
            students[studentIndex][property][index] = value;
            saveData();
        }
        
        // تابع برای به‌روزرسانی نمایش امتیاز کل
        function updateTotalScoreDisplay() {
            const studentIndex = document.getElementById('modalStudentId').value;
            const totalScore = calculateTotalScore(students[studentIndex]);
            document.getElementById('totalScoreDisplay').textContent = `امتیاز کل: ${totalScore}`;
        }
        
        // تابع برای ذخیره جزئیات دانشجو
        function saveStudentDetails() {
            const studentIndex = document.getElementById('modalStudentId').value;
            const student = students[studentIndex];
            
            student.studentCode = document.getElementById('modalStudentCode').value;
            student.city = document.getElementById('modalCity').value;
            student.major = document.getElementById('modalMajor').value;
            student.minor = document.getElementById('modalMinor').value;
            student.notes = document.getElementById('modalNotes').value;
            
            // ذخیره وضعیت امتیازات ثابت
            student.isMarried = document.getElementById('modalIsMarried').checked;
            student.isMarriedPoints = parseInt(document.getElementById('modalIsMarriedPoints').value) || 0;
            student.hasChild = document.getElementById('modalHasChild').checked;
            student.hasChildPoints = parseInt(document.getElementById('modalHasChildPoints').value) || 0;
            student.hasJob = document.getElementById('modalHasJob').checked;
            student.hasJobPoints = parseInt(document.getElementById('modalHasJobPoints').value) || 0;
            student.hasAchievement = document.getElementById('modalHasAchievement').checked;
            student.hasAchievementPoints = parseInt(document.getElementById('modalHasAchievementPoints').value) || 0;
            
            saveData();
            renderStudents();
            closeModal('studentModal');
            alert('تغییرات با موفقیت ذخیره شد.');
        }
        
        // تابع برای به‌روزرسانی حضور و غیاب
        function updateAttendance(studentId, sessionId, isPresent) {
            if (isPresent) {
                // اگر قبلاً ثبت نشده، اضافه کن
                if (!attendance.some(a => a.studentId === studentId && a.sessionId === sessionId)) {
                    attendance.push({
                        studentId: studentId,
                        sessionId: sessionId
                    });
                }
            } else {
                // اگر قبلاً ثبت شده، حذف کن
                const index = attendance.findIndex(a => a.studentId === studentId && a.sessionId === sessionId);
                if (index !== -1) {
                    attendance.splice(index, 1);
                }
            }
            
            saveData();
        }
        
        // تابع برای افزودن کلاس
        document.getElementById('classForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const className = document.getElementById('className').value;
            const classDescription = document.getElementById('classDescription').value;
            
            const newClass = {
                id: generateId(),
                name: className,
                description: classDescription
            };
            
            classes.push(newClass);
            saveData();
            renderClasses();
            renderClassSelectors();
            
            document.getElementById('classForm').reset();
            alert('کلاس با موفقیت اضافه شد.');
        });
        
        // تابع برای افزودن جلسه
        document.getElementById('sessionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const sessionTitle = document.getElementById('sessionTitle').value;
            const sessionDate = document.getElementById('sessionDate').value;
            const sessionDescription = document.getElementById('sessionDescription').value;
            const classId = document.getElementById('sessionClass').value;
            
            if (!classId) {
                alert('لطفاً یک کلاس انتخاب کنید.');
                return;
            }
            
            const newSession = {
                id: generateId(),
                classId: classId,
                title: sessionTitle,
                date: sessionDate,
                description: sessionDescription
            };
            
            sessions.push(newSession);
            saveData();
            renderSessions();
            
            document.getElementById('sessionForm').reset();
            alert('جلسه با موفقیت اضافه شد.');
        });
        
        // تابع برای افزودن دانشجو
        document.getElementById('studentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const studentName = document.getElementById('studentName').value;
            const studentNotes = document.getElementById('studentNotes').value;
            const classId = document.getElementById('studentClass').value;
            
            if (!classId) {
                alert('لطفاً یک کلاس انتخاب کنید.');
                return;
            }
            
            const newStudent = {
                id: generateId(),
                classId: classId,
                name: studentName,
                notes: studentNotes
            };
            
            students.push(newStudent);
            saveData();
            renderStudents();
            
            document.getElementById('studentForm').reset();
            alert('دانشجو با موفقیت اضافه شد.');
        });
        
        // تابع برای تولید ID یکتا
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // تابع برای نمایش/مخفی کردن بخش افزودن گروهی
        function toggleBulkAdd() {
            const bulkAddSection = document.getElementById('bulkAddSection');
            if (bulkAddSection.style.display === 'none') {
                bulkAddSection.style.display = 'block';
            } else {
                bulkAddSection.style.display = 'none';
            }
        }
        
        // تابع برای افزودن گروهی دانشجویان
        function addBulkStudents() {
            const classId = document.getElementById('studentClass').value;
            const bulkNames = document.getElementById('bulkStudentNames').value;
            
            if (!classId) {
                alert('لطفاً یک کلاس انتخاب کنید.');
                return;
            }
            
            if (!bulkNames.trim()) {
                alert('لطفاً نام دانشجویان را وارد کنید.');
                return;
            }
            
            const names = bulkNames.split('\n').filter(name => name.trim() !== '');
            
            names.forEach(name => {
                const newStudent = {
                    id: generateId(),
                    classId: classId,
                    name: name.trim(),
                    notes: ''
                };
                
                students.push(newStudent);
            });
            
            saveData();
            renderStudents();
            toggleBulkAdd();
            document.getElementById('bulkStudentNames').value = '';
            alert(`${names.length} دانشجو با موفقیت اضافه شدند.`);
        }
        
        // تابع برای حذف همه دانشجویان کلاس فعلی
        function deleteAllStudents() {
            const classId = document.getElementById('studentClass').value;
            
            if (!classId) {
                alert('لطفاً یک کلاس انتخاب کنید.');
                return;
            }
            
            if (confirm('آیا از حذف همه دانشجویان این کلاس اطمینان دارید؟ این عمل قابل بازگشت نیست.')) {
                students = students.filter(s => s.classId !== classId);
                saveData();
                renderStudents();
                alert('همه دانشجویان این کلاس حذف شدند.');
            }
        }
        
        // تابع برای حذف کلاس
        function deleteClass(index) {
            if (confirm('آیا از حذف این کلاس اطمینان دارید؟ تمام دانشجویان و جلسات مربوطه نیز حذف خواهند شد.')) {
                const classId = classes[index].id;
                
                // حذف دانشجویان مربوطه
                students = students.filter(s => s.classId !== classId);
                
                // حذف جلسات مربوطه
                sessions = sessions.filter(s => s.classId !== classId);
                
                // حذف کلاس
                classes.splice(index, 1);
                
                saveData();
                renderClasses();
                renderClassSelectors();
                alert('کلاس با موفقیت حذف شد.');
            }
        }
        
        // تابع برای حذف جلسه
        function deleteSession(index) {
            if (confirm('آیا از حذف این جلسه اطمینان دارید؟')) {
                const sessionId = sessions[index].id;
                
                // حذف حضور و غیاب مربوطه
                attendance = attendance.filter(a => a.sessionId !== sessionId);
                
                // حذف جلسه
                sessions.splice(index, 1);
                
                saveData();
                renderSessions();
                alert('جلسه با موفقیت حذف شد.');
            }
        }
        
        // تابع برای حذف دانشجو
        function deleteStudent(index) {
            if (confirm('آیا از حذف این دانشجو اطمینان دارید؟')) {
                const studentId = students[index].id;
                
                // حذف حضور و غیاب مربوطه
                attendance = attendance.filter(a => a.studentId !== studentId);
                
                // حذف دانشجو
                students.splice(index, 1);
                
                saveData();
                renderStudents();
                alert('دانشجو با موفقیت حذف شد.');
            }
        }
        
        // تابع برای ویرایش کلاس
        function editClass(index) {
            const cls = classes[index];
            const newName = prompt('نام جدید کلاس را وارد کنید:', cls.name);
            
            if (newName && newName.trim() !== '') {
                cls.name = newName.trim();
                const newDescription = prompt('توضیحات جدید کلاس را وارد کنید:', cls.description || '');
                cls.description = newDescription || '';
                
                saveData();
                renderClasses();
                renderClassSelectors();
                alert('کلاس با موفقیت ویرایش شد.');
            }
        }
        
        // تابع برای ویرایش جلسه
        function editSession(index) {
            const session = sessions[index];
            const newTitle = prompt('عنوان جدید جلسه را وارد کنید:', session.title);
            
            if (newTitle && newTitle.trim() !== '') {
                session.title = newTitle.trim();
                const newDate = prompt('تاریخ جدید جلسه را وارد کنید:', session.date);
                session.date = newDate || session.date;
                const newDescription = prompt('توضیحات جدید جلسه را وارد کنید:', session.description || '');
                session.description = newDescription || '';
                
                saveData();
                renderSessions();
                alert('جلسه با موفقیت ویرایش شد.');
            }
        }
        
        // تابع برای خروجی گرفتن به اکسل
        function exportToExcel() {
            const classId = document.getElementById('reportClass').value;
            
            if (!classId) {
                alert('لطفاً یک کلاس انتخاب کنید.');
                return;
            }
            
            const classStudents = students.filter(s => s.classId === classId);
            const classSessions = sessions.filter(s => s.classId === classId);
            
            if (classStudents.length === 0) {
                alert('هیچ دانشجویی در این کلاس وجود ندارد.');
                return;
            }
            
            // مرتب‌سازی اسامی بر اساس الفبای فارسی
            const sortedStudents = sortPersianNames(classStudents.map(s => s.name)).map(name => 
                classStudents.find(s => s.name === name)
            );
            
            // ایجاد داده‌های برای اکسل
            const data = [];
            
            // هدر جدول
            const header = ['نام دانشجو', 'کد دانشجویی', 'شهر', 'رشته اصلی', 'رشته فرعی', 'امتیاز کل'];
            classSessions.forEach(session => {
                header.push(session.title);
            });
            header.push('یادداشت‌ها');
            
            data.push(header);
            
            // داده‌های دانشجویان
            sortedStudents.forEach(student => {
                const row = [
                    student.name,
                    student.studentCode || '',
                    student.city || '',
                    student.major || '',
                    student.minor || '',
                    calculateTotalScore(student)
                ];
                
                classSessions.forEach(session => {
                    const isPresent = attendance.some(a => a.studentId === student.id && a.sessionId === session.id);
                    row.push(isPresent ? 'حاضر' : 'غایب');
                });
                
                row.push(student.notes || '');
                
                data.push(row);
            });
            
            // ایجاد workbook و worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // تنظیم عرض ستون‌ها
            const colWidths = [];
            for (let i = 0; i < header.length; i++) {
                colWidths.push({wch: 15});
            }
            ws['!cols'] = colWidths;
            
            // اضافه کردن worksheet به workbook
            XLSX.utils.book_append_sheet(wb, ws, 'گزارش کلاس');
            
            // دانلود فایل
            const className = classes.find(c => c.id === classId).name;
            XLSX.writeFile(wb, `گزارش_کلاس_${className}.xlsx`);
            
            alert('فایل Excel با موفقیت دانلود شد.');
        }
        
        // تابع برای وارد کردن اطلاعات از JSON
        function openImportModal() {
            document.getElementById('importJson').value = '';
            document.getElementById('importModal').style.display = 'block';
        }
        
        // تابع برای وارد کردن اطلاعات از JSON
        function importFromJson() {
            const jsonText = document.getElementById('importJson').value;
            
            if (!jsonText.trim()) {
                alert('لطفاً اطلاعات JSON را وارد کنید.');
                return;
            }
            
            try {
                const data = JSON.parse(jsonText);
                
                if (data.classes) classes = data.classes;
                if (data.students) students = data.students;
                if (data.sessions) sessions = data.sessions;
                if (data.attendance) attendance = data.attendance;
                
                saveData();
                renderClasses();
                renderClassSelectors();
                renderSessions();
                renderStudents();
                
                closeModal('importModal');
                alert('اطلاعات با موفقیت وارد شد.');
            } catch (e) {
                alert('خطا در پردازش JSON. لطفاً از صحت فرمت اطمینان حاصل کنید.');
                console.error(e);
            }
        }
        
        // تابع برای خروجی گرفتن اطلاعات به JSON
        function openExportModal() {
            const data = {
                classes: classes,
                students: students,
                sessions: sessions,
                attendance: attendance
            };
            
            document.getElementById('exportJson').value = JSON.stringify(data, null, 2);
            document.getElementById('exportModal').style.display = 'block';
        }
        
        // تابع برای کپی کردن JSON به کلیپ‌بورد
        function copyToClipboard() {
            const textarea = document.getElementById('exportJson');
            textarea.select();
            document.execCommand('copy');
            alert('JSON با موفقیت کپی شد.');
        }
        
        // تابع برای بازنشانی همه اطلاعات
        function resetData() {
            if (confirm('آیا از بازنشانی همه اطلاعات اطمینان دارید؟ این عمل قابل بازگشت نیست.')) {
                classes = [];
                students = [];
                sessions = [];
                attendance = [];
                
                saveData();
                renderClasses();
                renderClassSelectors();
                renderSessions();
                renderStudents();
                
                alert('همه اطلاعات با موفقیت بازنشانی شدند.');
            }
        }
        
        // تابع برای وارد کردن اطلاعات از اکسل
        function importFromExcel() {
            document.getElementById('excelFileInput').click();
        }
        
        // رویداد تغییر فایل اکسل
        document.getElementById('excelFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const classId = document.getElementById('studentClass').value;
            
            if (!classId) {
                alert('لطفاً یک کلاس انتخاب کنید.');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // فرض می‌کنیم اولین sheet حاوی داده‌هاست
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    // حذف هدر
                    jsonData.shift();
                    
                    // افزودن دانشجویان
                    let addedCount = 0;
                    jsonData.forEach(row => {
                        if (row[0] && row[0].trim() !== '') {
                            const newStudent = {
                                id: generateId(),
                                classId: classId,
                                name: row[0].trim(),
                                notes: row[1] || ''
                            };
                            
                            students.push(newStudent);
                            addedCount++;
                        }
                    });
                    
                    saveData();
                    renderStudents();
                    
                    alert(`${addedCount} دانشجو از فایل اکسل با موفقیت وارد شدند.`);
                    
                    // ریست کردن ورودی فایل
                    document.getElementById('excelFileInput').value = '';
                } catch (error) {
                    alert('خطا در خواندن فایل اکسل. لطفاً از صحت فرمت فایل اطمینان حاصل کنید.');
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        });
        
        // مقداردهی اولیه
        window.onload = function() {
            renderClasses();
            renderClassSelectors();
            renderSessions();
            renderStudents();
        };
    </script>
</body>
</html>
