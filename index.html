<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استادیار - سیستم مدیریت حضور و غیاب کلاس</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap');
        
        @font-face {
            font-family: 'AbarLowFaNum';
            src: url('./fonts/AbarLowFaNum-Regular.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'AbarLowFaNum', 'Vazirmatn', 'Tahoma', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            direction: rtl;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            position: relative;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
            z-index: -1;
        }
        
        .header h1 {
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #fff, #f0f8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            font-size: 1.2em;
            font-weight: 300;
            opacity: 0.9;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.1),
                0 0 0 1px rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 40px;
            border-bottom: none;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 20px;
            padding: 8px;
            position: relative;
        }
        
        .tabs::before {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: calc(25% - 8px);
            height: calc(100% - 16px);
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transform: translateX(calc(var(--active-tab, 0) * -100%));
        }
        
        .tab {
            flex: 1;
            padding: 18px 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            font-family: inherit;
            border-radius: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #666;
            position: relative;
            z-index: 2;
        }
        
        .tab.active {
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .tab:hover:not(.active) {
            color: #667eea;
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(20px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }
        
        .tab-content h2 {
            font-size: 2em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 30px;
            position: relative;
            padding-bottom: 15px;
        }
        
        .tab-content h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
        }
        
        .form-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e3f2fd;
            border-radius: 15px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 
                0 0 0 4px rgba(102, 126, 234, 0.1),
                0 10px 25px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(40, 167, 69, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #e91e63);
            color: white;
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(220, 53, 69, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #6f42c1);
            color: white;
            box-shadow: 0 8px 20px rgba(23, 162, 184, 0.3);
        }
        
        .btn-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(23, 162, 184, 0.4);
        }
        
        .sessions-list, .students-list {
            margin-top: 30px;
        }
        
        .session-item, .student-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
            backdrop-filter: blur(10px);
            padding: 25px;
            margin: 20px 0;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 
                0 8px 32px rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .session-item::before, .student-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 0 20px 20px 0;
        }
        
        .session-item:hover, .student-item:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.15),
                inset 0 1px 0 rgba(255,255,255,0.5);
        }
        
        .session-header, .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .session-title, .student-name {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .session-item p, .student-item p {
            color: #5a6c7d;
            line-height: 1.6;
            margin: 8px 0;
        }
        
        .session-item p strong, .student-item p strong {
            color: #2c3e50;
            font-weight: 600;
        }
        
        .attendance-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .attendance-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.95));
            backdrop-filter: blur(15px);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .attendance-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .attendance-item input[type="checkbox"] {
            margin-left: 15px;
            transform: scale(1.3);
            accent-color: #667eea;
        }
        
        .student-name-clickable {
            cursor: pointer;
            color: #667eea;
            font-weight: 500;
            text-decoration: none;
            flex-grow: 1;
            transition: all 0.3s ease;
        }
        
        .student-name-clickable:hover {
            color: #5a6fd8;
            text-shadow: 0 1px 3px rgba(0,126,234, 0.3);
        }
        
        .score-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 15px;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.95));
            backdrop-filter: blur(20px);
            margin: 2% auto;
            padding: 40px;
            border-radius: 25px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.2),
                0 0 0 1px rgba(255,255,255,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }
        
        .close {
            position: absolute;
            left: 25px;
            top: 25px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
        }
        
        .close:hover {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            transform: rotate(90deg);
        }
        
        .modal h2 {
            margin-bottom: 35px;
            color: #2c3e50;
            font-size: 2.2em;
            font-weight: 700;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            background: linear-gradient(135deg, #2c3e50, #667eea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0;
            padding: 15px 18px;
            background: white;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            transition: border-color 0.2s ease;
        }
        
        .checkbox-group:hover {
            border-color: #667eea;
        }
        
        .checkbox-group input[type="checkbox"] {
            order: 2;
            width: 20px;
            height: 20px;
            accent-color: #667eea;
            cursor: pointer;
        }
        
        .checkbox-group label {
            font-weight: 500;
            color: #000000;
            cursor: pointer;
            order: 1;
        }
        
        .dynamic-list {
            border: 2px solid rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            background: rgba(255,255,255,0.4);
            backdrop-filter: blur(10px);
        }
        
        .dynamic-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(15px);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        
        .dynamic-item input {
            flex: 1;
            margin-left: 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        .score-display {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            margin: 25px 0;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .export-section {
            text-align: center;
            margin: 40px 0;
            padding: 30px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .export-section h3 {
            font-size: 1.8em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            pointer-events: none;
        }
        
        .stat-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
        }
        
        .stat-number {
            font-size: 2.8em;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }
        
        .stat-label {
            font-size: 1em;
            font-weight: 500;
            margin-top: 8px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 60px 20px;
            background: rgba(255,255,255,0.5);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 2px dashed rgba(153,153,153,0.3);
        }
        
        .bulk-add-section {
            margin-top: 20px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .bulk-add-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .bulk-add-section p {
            color: #666;
            margin-bottom: 15px;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a42a8);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .main-content {
                padding: 25px 20px;
                border-radius: 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: calc(50% - 8px);
                margin: 4px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .attendance-list {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>استادیار - سیستم مدیریت حضور و غیاب کلاس</h1>
            <p>مدیریت کامل جلسات، دانشجویان و امتیازدهی</p>
        </div>
        
        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('sessions')">جلسات</button>
                <button class="tab" onclick="showTab('students')">دانشجویان</button>
                <button class="tab" onclick="showTab('attendance')">حضور و غیاب</button>
                <button class="tab" onclick="showTab('reports')">گزارشات</button>
            </div>
            
            <div id="sessions" class="tab-content active">
                <h2>مدیریت جلسات</h2>
                <form id="sessionForm">
                    <div class="form-group">
                        <label>عنوان جلسه:</label>
                        <input type="text" id="sessionTitle" required>
                    </div>
                    <div class="form-group">
                        <label>تاریخ جلسه (شمسی):</label>
                        <input type="text" id="sessionDate" placeholder="مثال: 1403/07/12" required>
                    </div>
                    <div class="form-group">
                        <label>توضیحات:</label>
                        <textarea id="sessionDescription" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">افزودن جلسه</button>
                </form>
                
                <div class="sessions-list" id="sessionsList"></div>
            </div>
            
            <div id="students" class="tab-content">
                <h2>مدیریت دانشجویان</h2>
                <form id="studentForm">
                    <div class="form-group">
                        <label>نام دانشجو:</label>
                        <input type="text" id="studentName" required>
                    </div>
                    <div class="form-group">
                        <label>توضیحات کلی:</label>
                        <textarea id="studentNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">افزودن دانشجو</button>
                    <button type="button" onclick="toggleBulkAdd()" class="btn btn-info">افزودن گروهی</button>
                </form>
                
                <div id="bulkAddSection" class="bulk-add-section" style="display: none;">
                    <h3>افزودن چند دانشجو به صورت همزمان</h3>
                    <p>هر نام را در یک خط جداگانه وارد کنید:</p>
                    <textarea id="bulkStudentNames" rows="8" placeholder="دانشجو ۱&#10;دانشجو ۲&#10;دانشجو ۳&#10;..." style="width: 100%; padding: 16px 20px; border: 2px solid #e3f2fd; border-radius: 15px; font-size: 15px; font-family: inherit; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px);"></textarea>
                    <div style="margin-top: 15px;">
                        <button type="button" onclick="addBulkStudents()" class="btn btn-success">افزودن همه</button>
                        <button type="button" onclick="toggleBulkAdd()" class="btn btn-danger">انصراف</button>
                    </div>
                </div>
                
                <div class="students-list" id="studentsList"></div>
            </div>
            
            <div id="attendance" class="tab-content">
                <h2>حضور و غیاب</h2>
                <div id="attendanceContent"></div>
            </div>
            
            <div id="reports" class="tab-content">
                <h2>گزارشات و آمار</h2>
                <div class="stats-grid" id="statsGrid"></div>
                <div class="export-section">
                    <h3>خروجی داده‌ها</h3>
                    <p style="margin-bottom: 20px; color: #666;">تمام اطلاعات را در قالب فایل Excel دریافت کنید</p>
                    <button onclick="exportToExcel()" class="btn btn-success">دانلود فایل Excel</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>جزئیات دانشجو</h2>
            <form id="studentDetailsForm">
                <input type="hidden" id="modalStudentId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>نام دانشجو:</label>
                        <input type="text" id="modalStudentName" readonly>
                    </div>
                    <div class="form-group">
                        <label>شهر محل زندگی:</label>
                        <input type="text" id="modalCity">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>رشته اصلی:</label>
                        <input type="text" id="modalMajor">
                    </div>
                    <div class="form-group">
                        <label>رشته فرعی:</label>
                        <input type="text" id="modalMinor">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>کتاب‌های مطالعه‌شده:</label>
                    <div class="dynamic-list" id="booksList">
                        <button type="button" onclick="addBook()" class="btn btn-info">+ افزودن کتاب</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>فیلم‌های دیده‌شده:</label>
                    <div class="dynamic-list" id="moviesList">
                        <button type="button" onclick="addMovie()" class="btn btn-info">+ افزودن فیلم</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>سریال‌های دیده‌شده:</label>
                    <div class="dynamic-list" id="seriesList">
                        <button type="button" onclick="addSeries()" class="btn btn-info">+ افزودن سریال</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>وضعیت امتیازات ثابت:</label>
                    <div class="checkbox-group">
                        <label>متأهل</label>
                        <input type="checkbox" id="modalIsMarried">
                        <input type="number" id="modalIsMarriedPoints" placeholder="امتیاز" style="width: 80px; margin-right: 10px;">
                    </div>
                    <div class="checkbox-group">
                        <label>داشتن فرزند</label>
                        <input type="checkbox" id="modalHasChild">
                        <input type="number" id="modalHasChildPoints" placeholder="امتیاز" style="width: 80px; margin-right: 10px;">
                    </div>
                    <div class="checkbox-group">
                        <label>داشتن شغل</label>
                        <input type="checkbox" id="modalHasJob">
                        <input type="number" id="modalHasJobPoints" placeholder="امتیاز" style="width: 80px; margin-right: 10px;">
                    </div>
                    <div class="checkbox-group">
                        <label>داشتن مقام یا قهرمانی</label>
                        <input type="checkbox" id="modalHasAchievement">
                        <input type="number" id="modalHasAchievementPoints" placeholder="امتیاز" style="width: 80px; margin-right: 10px;">
                    </div>
                </div>
                
                <div class="form-group">
                    <div id="sessionScoresList"></div>
                </div>
                
                <div class="score-display" id="modalScore">
                    امتیاز کل: 0
                </div>
                
                <button type="button" onclick="saveStudentDetails()" class="btn btn-success">ذخیره</button>
            </form>
        </div>
    </div>

    <script>
        // امتیازات قابل تنظیم توسط کاربر
        let scoreConfig = {
            // امتیازات ثابت
            isMarried: 1,
            hasChild: 1,
            hasJob: 1,
            hasAchievement: 1,
            
            // امتیازات هر جلسه
            absent: -1,
            noClassNotes: -0.25,
            noHomework: -1,
            writesNotes: 0.25,
            extraClasses: 1,
            motahhariStudy: 1,
            
            // امتیازات تجمعی
            series: 3,
            movie: 1,
            longBook: 6,
            shortBook: 3
        };

        let sessions = [];
        let students = [];
        let attendance = {};
        let studentDetails = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            renderSessions();
            renderStudents();
            renderAttendance();
            renderStats();
            
            // Set today's Persian date as default
            const today = new Date();
            const persianToday = gregorianToJalali(today.getFullYear(), today.getMonth() + 1, today.getDate());
            document.getElementById('sessionDate').value = `${persianToday[0]}/${persianToday[1]}/${persianToday[2]}`;
            
            // Set up form submissions
            document.getElementById('sessionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addSession();
            });
            
            document.getElementById('studentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addStudent();
            });
        });
        
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show the selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Set active tab
            const tabs = document.querySelectorAll('.tab');
            for (let i = 0; i < tabs.length; i++) {
                if (tabs[i].textContent === document.querySelector(`[onclick="showTab('${tabName}')"]`).textContent) {
                    tabs[i].classList.add('active');
                    document.documentElement.style.setProperty('--active-tab', i);
                    break;
                }
            }
            
            // Update content for specific tabs
            if (tabName === 'attendance') {
                renderAttendance();
            } else if (tabName === 'reports') {
                renderStats();
            }
        }
        
        function addSession() {
            const title = document.getElementById('sessionTitle').value;
            const date = document.getElementById('sessionDate').value;
            const description = document.getElementById('sessionDescription').value;
            
            const session = {
                id: Date.now(),
                title,
                date,
                description
            };
            
            sessions.push(session);
            saveData();
            renderSessions();
            
            // Reset form
            document.getElementById('sessionForm').reset();
            
            // Set today's Persian date as default
            const today = new Date();
            const persianToday = gregorianToJalali(today.getFullYear(), today.getMonth() + 1, today.getDate());
            document.getElementById('sessionDate').value = `${persianToday[0]}/${persianToday[1]}/${persianToday[2]}`;
        }
        
        function renderSessions() {
            const sessionsList = document.getElementById('sessionsList');
            
            if (sessions.length === 0) {
                sessionsList.innerHTML = '<div class="empty-state">هنوز جلسه‌ای اضافه نشده است</div>';
                return;
            }
            
            sessionsList.innerHTML = sessions.map(session => `
                <div class="session-item">
                    <div class="session-header">
                        <div class="session-title">${session.title}</div>
                        <div>
                            <button onclick="deleteSession(${session.id})" class="btn btn-danger">حذف</button>
                        </div>
                    </div>
                    <p><strong>تاریخ:</strong> ${session.date}</p>
                    <p><strong>توضیحات:</strong> ${session.description}</p>
                </div>
            `).join('');
        }
        
        // حذف جلسه با تاثیر در آمار و گزارشات و حذف کامل از attendance
        function deleteSession(id) {
            if (confirm('آیا از حذف این جلسه اطمینان دارید؟')) {
                sessions = sessions.filter(session => session.id !== id);
                delete attendance[id];
                // حذف sessionScores مربوط به این جلسه از همه دانشجویان
                Object.keys(studentDetails).forEach(studentId => {
                    if (studentDetails[studentId].sessionScores) {
                        delete studentDetails[studentId].sessionScores[id];
                    }
                });
                saveData();
                renderSessions();
                renderAttendance();
                renderStats();
            }
        }
        
        function addStudent() {
            const name = document.getElementById('studentName').value;
            const notes = document.getElementById('studentNotes').value;
            
            const student = {
                id: Date.now(),
                name,
                notes
            };
            
            students.push(student);
            saveData();
            renderStudents();
            
            // Reset form
            document.getElementById('studentForm').reset();
        }
        
        function toggleBulkAdd() {
            const bulkSection = document.getElementById('bulkAddSection');
            if (bulkSection.style.display === 'none') {
                bulkSection.style.display = 'block';
            } else {
                bulkSection.style.display = 'none';
            }
        }
        
        function addBulkStudents() {
            const namesText = document.getElementById('bulkStudentNames').value;
            if (!namesText.trim()) {
                alert('لطفاً نام دانشجویان را وارد کنید');
                return;
            }
            
            const names = namesText.split('\n').filter(name => name.trim() !== '');
            
            names.forEach(name => {
                const student = {
                    id: Date.now() + Math.random(),
                    name: name.trim(),
                    notes: ''
                };
                
                students.push(student);
            });
            
            saveData();
            renderStudents();
            toggleBulkAdd();
            
            // Clear the textarea
            document.getElementById('bulkStudentNames').value = '';
        }
        
        function renderStudents() {
            const studentsList = document.getElementById('studentsList');
            
            if (students.length === 0) {
                studentsList.innerHTML = '<div class="empty-state">هنوز دانشجویی اضافه نشده است</div>';
                return;
            }
            
            studentsList.innerHTML = students.map(student => {
                const studentDetail = studentDetails[student.id] || {};
                const totalScore = calculateStudentScore(student.id);
                
                return `
                    <div class="student-item">
                        <div class="student-header">
                            <div class="student-name">${student.name}</div>
                            <div>
                                <button onclick="editStudent(${student.id})" class="btn btn-primary">ویرایش</button>
                                <button onclick="deleteStudent(${student.id})" class="btn btn-danger">حذف</button>
                            </div>
                        </div>
                        <p><strong>توضیحات:</strong> ${student.notes}</p>
                        <p><strong>امتیاز کل:</strong> <span class="score-badge">${totalScore}</span></p>
                    </div>
                `;
            }).join('');
        }
        
        // حذف دانشجو با تاثیر در آمار و گزارشات و حذف کامل از attendance
        function deleteStudent(id) {
            if (confirm('آیا از حذف این دانشجو اطمینان دارید؟')) {
                students = students.filter(student => student.id !== id);
                delete studentDetails[id];
                // حذف دانشجو از attendance همه جلسات
                Object.keys(attendance).forEach(sessionId => {
                    if (attendance[sessionId]) {
                        delete attendance[sessionId][id];
                    }
                });
                saveData();
                renderStudents();
                renderAttendance();
                renderStats(); // آمار را هم به‌روزرسانی کن
            }
        }
        
        // حذف همه دانشجویان (در صورت نیاز)
        function deleteAllStudents() {
            if (confirm('آیا از حذف همه دانشجویان اطمینان دارید؟')) {
                students = [];
                studentDetails = {};
                // حذف همه دانشجویان از attendance همه جلسات
                Object.keys(attendance).forEach(sessionId => {
                    attendance[sessionId] = {};
                });
                saveData();
                renderStudents();
                renderAttendance();
                renderStats();
            }
        }
        
        function editStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;
            
            const studentDetail = studentDetails[id] || {
                books: [],
                movies: [],
                series: [],
                city: '',
                major: '',
                minor: '',
                isMarried: false,
                hasChild: false,
                hasJob: false,
                hasAchievement: false,
                sessionScores: {}
            };
            
            document.getElementById('modalStudentId').value = id;
            document.getElementById('modalStudentName').value = student.name;
            document.getElementById('modalCity').value = studentDetail.city || '';
            document.getElementById('modalMajor').value = studentDetail.major || '';
            document.getElementById('modalMinor').value = studentDetail.minor || '';
            document.getElementById('modalIsMarried').checked = studentDetail.isMarried || false;
            document.getElementById('modalHasChild').checked = studentDetail.hasChild || false;
            document.getElementById('modalHasJob').checked = studentDetail.hasJob || false;
            document.getElementById('modalHasAchievement').checked = studentDetail.hasAchievement || false;
            
            // Set custom point values
            document.getElementById('modalIsMarriedPoints').value = studentDetail.isMarriedPoints || scoreConfig.isMarried;
            document.getElementById('modalHasChildPoints').value = studentDetail.hasChildPoints || scoreConfig.hasChild;
            document.getElementById('modalHasJobPoints').value = studentDetail.hasJobPoints || scoreConfig.hasJob;
            document.getElementById('modalHasAchievementPoints').value = studentDetail.hasAchievementPoints || scoreConfig.hasAchievement;
            
            renderBooksList(studentDetail.books || []);
            renderMoviesList(studentDetail.movies || []);
            renderSeriesList(studentDetail.series || []);
            renderSessionScores(id);
            
            updateModalScore(id);
            
            document.getElementById('studentModal').style.display = 'block';
        }
        
        function renderBooksList(books) {
            const booksList = document.getElementById('booksList');
            booksList.innerHTML = '<button type="button" onclick="addBook()" class="btn btn-info">+ افزودن کتاب</button>';
            
            books.forEach((book, index) => {
                const bookItem = document.createElement('div');
                bookItem.className = 'dynamic-item';
                bookItem.innerHTML = `
                    <input type="text" placeholder="نام کتاب" value="${book.name}" onchange="updateBook(${index}, this.value, ${book.points})">
                    <input type="number" placeholder="امتیاز" value="${book.points}" onchange="updateBookPoints(${index}, '${book.name}', this.value)" style="width: 100px; margin-right: 10px;">
                    <button type="button" onclick="removeBook(${index})" class="btn btn-danger">حذف</button>
                `;
                booksList.appendChild(bookItem);
            });
        }
        
        function addBook() {
            const studentId = document.getElementById('modalStudentId').value;
            const studentDetail = studentDetails[studentId] || {
                books: [],
                movies: [],
                series: [],
                city: '',
                major: '',
                minor: '',
                isMarried: false,
                hasChild: false,
                hasJob: false,
                hasAchievement: false,
                sessionScores: {}
            };
            
            studentDetail.books.push({ name: '', points: scoreConfig.shortBook });
            studentDetails[studentId] = studentDetail;
            renderBooksList(studentDetail.books);
        }
        
        function updateBook(index, name, points) {
            const studentId = document.getElementById('modalStudentId').value;
            const studentDetail = studentDetails[studentId];
            if (studentDetail && studentDetail.books[index]) {
                studentDetail.books[index].name = name;
                updateModalScore(studentId);
            }
        }
        
        function updateBookPoints(index, name, points) {
            const studentId = document.getElementById('modalStudentId').value;
            const studentDetail = studentDetails[studentId];
            if (studentDetail && studentDetail.books[index]) {
                studentDetail.books[index].points = parseInt(points) || 0;
                updateModalScore(studentId);
            }
        }
        
        function removeBook(index) {
            const studentId = document.getElementById('modalStudentId').value;
            const studentDetail = studentDetails[studentId];
            if (studentDetail) {
                studentDetail.books.splice(index, 1);
                renderBooksList(studentDetail.books);
                updateModalScore(studentId);
            }
        }
        
        function renderMoviesList(movies) {
            const moviesList = document.getElementById('moviesList');
            moviesList.innerHTML = '<button type="button" onclick="addMovie()" class="btn btn-info">+ افزودن فیلم</button>';
            
            movies.forEach((movie, index) => {
                const movieItem = document.createElement('div');
                movieItem.className = 'dynamic-item';
                movieItem.innerHTML = `
                    <input type="text" placeholder="نام فیلم" value="${movie.name}" onchange="updateMovie(${index}, this.value, ${movie.points})">
                    <input type="number" placeholder="امتیاز" value="${movie.points}" onchange="updateMoviePoints(${index}, '${movie.name}', this.value)" style="width: 100px; margin-right: 10px;">
                    <button type="button" onclick="removeMovie(${index})" class="btn btn-danger">حذف</button>
                `;
                moviesList.appendChild(movieItem);
            });
        }
        
        function addMovie() {
            const studentId = document.getElementById('modalStudentId').value;
            const studentDetail = studentDetails[studentId] || {
                books: [],
                movies: [],
                series: [],
                city: '',
                major: '',
                minor: '',
                isMarried: false,
                hasChild: false,
                hasJob: false,
                hasAchievement: false,
                sessionScores: {}
            };
            
            studentDetail.movies.push({ name: '', points: scoreConfig.movie });
            studentDetails[studentId] = studentDetail;
            renderMoviesList(studentDetail.movies);
        }
        
        function updateMovie(index, name, points) {
            const studentId = document.getElementById('modalStudentId').value;
            const studentDetail = studentDetails[studentId];
            if (studentDetail && studentDetail.movies[index]) {
                studentDetail.movies[index].name = name;
                updateModalScore(studentId);
            }
        }
        
        function updateMoviePoints(index, name, points) {
            const studentId = document.getElementById('modalStudentId').value;
            const studentDetail = studentDetails[studentId];
            if (studentDetail && studentDetail.movies[index]) {
                studentDetail.movies[index].points = parseInt(points) || 0;
                updateModalScore(studentId);
            }
        }
        
        function removeMovie(index) {
            const studentId = document.getElementById('modalStudentId').value;
            const studentDetail = studentDetails[studentId];
            if (studentDetail) {
                studentDetail.movies.splice(index, 1);
                renderMoviesList(studentDetail.movies);
                updateModalScore(studentId);
            }
        }
        
        function renderSeriesList(series) {
            const seriesList = document.getElementById('seriesList');
            seriesList.innerHTML = '<button type="button" onclick="addSeries()" class="btn btn-info">+ افزودن سریال</button>';
            
            series.forEach((seriesItem, index) => {
                const seriesElement = document.createElement('div');
                seriesElement.className = 'dynamic-item';
                seriesElement.innerHTML = `
                    <input type="text" placeholder="نام سریال" value="${seriesItem.name}" onchange="updateSeries(${index}, this.value, ${seriesItem.points})">
                    <input type="number" placeholder="امتیاز" value="${seriesItem.points}" onchange="updateSeriesPoints(${index}, '${seriesItem.name}', this.value)" style="width: 100px; margin-right: 10px;">
                    <button type="button" onclick="removeSeries(${index})" class="btn btn-danger">حذف</button>
                `;
                seriesList.appendChild(seriesElement);
            });
        }
        
        function addSeries() {
            const studentId = document.getElementById('modalStudentId').value;
            const studentDetail = studentDetails[studentId] || {
                books: [],
                movies: [],
                series: [],
                city: '',
                major: '',
                minor: '',
                isMarried: false,
                hasChild: false,
                hasJob: false,
                hasAchievement: false,
                sessionScores: {}
            };
            
            studentDetail.series.push({ name: '', points: scoreConfig.series });
            studentDetails[studentId] = studentDetail;
            renderSeriesList(studentDetail.series);
        }
        
        function updateSeries(index, name, points) {
            const studentId = document.getElementById('modalStudentId').value;
            const studentDetail = studentDetails[studentId];
            if (studentDetail && studentDetail.series[index]) {
                studentDetail.series[index].name = name;
                updateModalScore(studentId);
            }
        }
        
        function updateSeriesPoints(index, name, points) {
            const studentId = document.getElementById('modalStudentId').value;
            const studentDetail = studentDetails[studentId];
            if (studentDetail && studentDetail.series[index]) {
                studentDetail.series[index].points = parseInt(points) || 0;
                updateModalScore(studentId);
            }
        }
        
        function removeSeries(index) {
            const studentId = document.getElementById('modalStudentId').value;
            const studentDetail = studentDetails[studentId];
            if (studentDetail) {
                studentDetail.series.splice(index, 1);
                renderSeriesList(studentDetail.series);
                updateModalScore(studentId);
            }
        }
        
        function renderSessionScores(studentId) {
            const sessionScoresList = document.getElementById('sessionScoresList');
            sessionScoresList.innerHTML = '<h3 style="margin-bottom: 15px;">امتیازات جلسات</h3>';
            
            const studentDetail = studentDetails[studentId] || {};
            const sessionScores = studentDetail.sessionScores || {};
            
            sessions.forEach(session => {
                const sessionScore = sessionScores[session.id] || {
                    noClassNotes: false,
                    noHomework: false,
                    writesNotes: false,
                    extraClasses: false,
                    motahhariStudy: false
                };
                
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'dynamic-list';
                sessionDiv.innerHTML = `
                    <h4 style="margin-bottom: 10px;">${session.title} (${session.date})</h4>
                    <div class="checkbox-group">
                        <label>نداشتن جزوه کلاس</label>
                        <input type="checkbox" ${sessionScore.noClassNotes ? 'checked' : ''} onchange="updateSessionScore(${studentId}, ${session.id}, 'noClassNotes', this.checked, ${scoreConfig.noClassNotes})">
                        <input type="number" value="${sessionScore.noClassNotesPoints || scoreConfig.noClassNotes}" onchange="updateSessionScorePoints(${studentId}, ${session.id}, 'noClassNotes', ${sessionScore.noClassNotes}, this.value)" style="width: 80px; margin-right: 10px;">
                    </div>
                    <div class="checkbox-group">
                        <label>نداشتن تکلیف</label>
                        <input type="checkbox" ${sessionScore.noHomework ? 'checked' : ''} onchange="updateSessionScore(${studentId}, ${session.id}, 'noHomework', this.checked, ${scoreConfig.noHomework})">
                        <input type="number" value="${sessionScore.noHomeworkPoints || scoreConfig.noHomework}" onchange="updateSessionScorePoints(${studentId}, ${session.id}, 'noHomework', ${sessionScore.noHomework}, this.value)" style="width: 80px; margin-right: 10px;">
                    </div>
                    <div class="checkbox-group">
                        <label>نوشتن جزوه در کلاس</label>
                        <input type="checkbox" ${sessionScore.writesNotes ? 'checked' : ''} onchange="updateSessionScore(${studentId}, ${session.id}, 'writesNotes', this.checked, ${scoreConfig.writesNotes})">
                        <input type="number" value="${sessionScore.writesNotesPoints || scoreConfig.writesNotes}" onchange="updateSessionScorePoints(${studentId}, ${session.id}, 'writesNotes', ${sessionScore.writesNotes}, this.value)" style="width: 80px; margin-right: 10px;">
                    </div>
                    <div class="checkbox-group">
                        <label>کلاس‌های فوق‌العاده</label>
                        <input type="checkbox" ${sessionScore.extraClasses ? 'checked' : ''} onchange="updateSessionScore(${studentId}, ${session.id}, 'extraClasses', this.checked, ${scoreConfig.extraClasses})">
                        <input type="number" value="${sessionScore.extraClassesPoints || scoreConfig.extraClasses}" onchange="updateSessionScorePoints(${studentId}, ${session.id}, 'extraClasses', ${sessionScore.extraClasses}, this.value)" style="width: 80px; margin-right: 10px;">
                    </div>
                    <div class="checkbox-group">
                        <label>مطالعه آثار مطهری</label>
                        <input type="checkbox" ${sessionScore.motahhariStudy ? 'checked' : ''} onchange="updateSessionScore(${studentId}, ${session.id}, 'motahhariStudy', this.checked, ${scoreConfig.motahhariStudy})">
                        <input type="number" value="${sessionScore.motahhariStudyPoints || scoreConfig.motahhariStudy}" onchange="updateSessionScorePoints(${studentId}, ${session.id}, 'motahhariStudy', ${sessionScore.motahhariStudy}, this.value)" style="width: 80px; margin-right: 10px;">
                    </div>
                `;
                sessionScoresList.appendChild(sessionDiv);
            });
        }
        
        function updateSessionScore(studentId, sessionId, field, value, points) {
            if (!studentDetails[studentId]) {
                studentDetails[studentId] = {
                    books: [],
                    movies: [],
                    series: [],
                    city: '',
                    major: '',
                    minor: '',
                    isMarried: false,
                    hasChild: false,
                    hasJob: false,
                    hasAchievement: false,
                    sessionScores: {}
                };
            }
            
            if (!studentDetails[studentId].sessionScores[sessionId]) {
                studentDetails[studentId].sessionScores[sessionId] = {
                    noClassNotes: false,
                    noHomework: false,
                    writesNotes: false,
                    extraClasses: false,
                    motahhariStudy: false
                };
            }
            
            studentDetails[studentId].sessionScores[sessionId][field] = value;
            studentDetails[studentId].sessionScores[sessionId][`${field}Points`] = points;
            updateModalScore(studentId);
        }
        
        function updateSessionScorePoints(studentId, sessionId, field, value, points) {
            if (!studentDetails[studentId]) return;
            if (!studentDetails[studentId].sessionScores[sessionId]) return;
            
            studentDetails[studentId].sessionScores[sessionId][`${field}Points`] = parseInt(points) || 0;
            updateModalScore(studentId);
        }
        
        function updateModalScore(studentId) {
            const totalScore = calculateStudentScore(studentId);
            document.getElementById('modalScore').textContent = `امتیاز کل: ${totalScore}`;
        }
        
        function saveStudentDetails() {
            const studentId = document.getElementById('modalStudentId').value;
            const studentDetail = studentDetails[studentId] || {
                books: [],
                movies: [],
                series: [],
                city: '',
                major: '',
                minor: '',
                isMarried: false,
                hasChild: false,
                hasJob: false,
                hasAchievement: false,
                sessionScores: {}
            };
            
            studentDetail.city = document.getElementById('modalCity').value;
            studentDetail.major = document.getElementById('modalMajor').value;
            studentDetail.minor = document.getElementById('modalMinor').value;
            studentDetail.isMarried = document.getElementById('modalIsMarried').checked;
            studentDetail.hasChild = document.getElementById('modalHasChild').checked;
            studentDetail.hasJob = document.getElementById('modalHasJob').checked;
            studentDetail.hasAchievement = document.getElementById('modalHasAchievement').checked;
            
            // Save custom point values
            studentDetail.isMarriedPoints = parseInt(document.getElementById('modalIsMarriedPoints').value) || scoreConfig.isMarried;
            studentDetail.hasChildPoints = parseInt(document.getElementById('modalHasChildPoints').value) || scoreConfig.hasChild;
            studentDetail.hasJobPoints = parseInt(document.getElementById('modalHasJobPoints').value) || scoreConfig.hasJob;
            studentDetail.hasAchievementPoints = parseInt(document.getElementById('modalHasAchievementPoints').value) || scoreConfig.hasAchievement;
            
            studentDetails[studentId] = studentDetail;
            saveData();
            renderStudents();
            closeModal();
        }
        
        function closeModal() {
            document.getElementById('studentModal').style.display = 'none';
        }
        
        function renderAttendance() {
            const attendanceContent = document.getElementById('attendanceContent');
            
            if (sessions.length === 0) {
                attendanceContent.innerHTML = '<div class="empty-state">ابتدا جلسه‌ای ایجاد کنید</div>';
                return;
            }
            
            if (students.length === 0) {
                attendanceContent.innerHTML = '<div class="empty-state">ابتدا دانشجویی اضافه کنید</div>';
                return;
            }
            
            let html = `
                <div class="form-group">
                    <label>انتخاب جلسه:</label>
                    <select id="attendanceSession" onchange="renderAttendanceList()">
                        ${sessions.map(session => `<option value="${session.id}">${session.title} (${session.date})</option>`).join('')}
                    </select>
                </div>
                <div id="attendanceListContainer"></div>
            `;
            
            attendanceContent.innerHTML = html;
            renderAttendanceList();
        }
        
        // چک لیست حضور و غیاب: پیش‌فرض همه غایب باشند (هیچکس حاضر نیست)
        function renderAttendanceList() {
            const sessionId = document.getElementById('attendanceSession').value;
            const container = document.getElementById('attendanceListContainer');
            if (!attendance[sessionId]) {
                attendance[sessionId] = {};
            }
            let html = `
                <h3 style="margin: 20px 0;">ثبت حضور و غیاب</h3>
                <div class="attendance-list">
                    ${students.map(student => {
                        // پیش‌فرض همه غایب هستند مگر اینکه چک بخورد
                        const isPresent = attendance[sessionId][student.id] === true;
                        return `
                            <div class="attendance-item">
                                <input type="checkbox" id="attendance_${student.id}" ${isPresent ? 'checked' : ''} onchange="updateAttendance('${sessionId}', '${student.id}', this.checked)">
                                <label for="attendance_${student.id}" class="student-name-clickable" onclick="editStudent(${student.id})">${student.name}</label>
                                <div class="score-badge">${calculateStudentScore(student.id)}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="margin-top: 20px;">
                    <button onclick="saveAttendance()" class="btn btn-success">ذخیره حضور و غیاب</button>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // تابع ثبت حضور و غیاب و هماهنگی با sessionScores (غیبت فقط با چک لیست انجام می‌شود)
        function updateAttendance(sessionId, studentId, isPresent) {
            if (!attendance[sessionId]) {
                attendance[sessionId] = {};
            }
            attendance[sessionId][studentId] = isPresent === true;
            // هماهنگ کردن با sessionScores فقط absent را ست کن
            if (!studentDetails[studentId]) {
                studentDetails[studentId] = {
                    books: [],
                    movies: [],
                    series: [],
                    city: '',
                    major: '',
                    minor: '',
                    isMarried: false,
                    hasChild: false,
                    hasJob: false,
                    hasAchievement: false,
                    sessionScores: {}
                };
            }
            if (!studentDetails[studentId].sessionScores[sessionId]) {
                studentDetails[studentId].sessionScores[sessionId] = {
                    noClassNotes: false,
                    noHomework: false,
                    writesNotes: false,
                    extraClasses: false,
                    motahhariStudy: false
                };
            }
            // absent فقط با حضور و غیاب ست شود
            studentDetails[studentId].sessionScores[sessionId].absent = !isPresent;
            studentDetails[studentId].sessionScores[sessionId].absentPoints = !isPresent ? scoreConfig.absent : 0;
            saveData();
            renderStats();
        }
        
        function saveAttendance() {
            saveData();
            alert('حضور و غیاب با موفقیت ذخیره شد');
        }
        
        function calculateStudentScore(studentId) {
            let totalScore = 0;
            const studentDetail = studentDetails[studentId];
            
            if (!studentDetail) return totalScore;
            
            // Calculate fixed scores
            if (studentDetail.isMarried) {
                totalScore += studentDetail.isMarriedPoints || scoreConfig.isMarried;
            }
            
            if (studentDetail.hasChild) {
                totalScore += studentDetail.hasChildPoints || scoreConfig.hasChild;
            }
            
            if (studentDetail.hasJob) {
                totalScore += studentDetail.hasJobPoints || scoreConfig.hasJob;
            }
            
            if (studentDetail.hasAchievement) {
                totalScore += studentDetail.hasAchievementPoints || scoreConfig.hasAchievement;
            }
            
            // Calculate book scores
            if (studentDetail.books) {
                studentDetail.books.forEach(book => {
                    if (book.name.trim() !== '') {
                        totalScore += book.points || 0;
                    }
                });
            }
            
            // Calculate movie scores
            if (studentDetail.movies) {
                studentDetail.movies.forEach(movie => {
                    if (movie.name.trim() !== '') {
                        totalScore += movie.points || 0;
                    }
                });
            }
            
            // Calculate series scores
            if (studentDetail.series) {
                studentDetail.series.forEach(series => {
                    if (series.name.trim() !== '') {
                        totalScore += series.points || 0;
                    }
                });
            }
            
            // Calculate session scores
            if (studentDetail.sessionScores) {
                Object.keys(studentDetail.sessionScores).forEach(sessionId => {
                    const sessionScore = studentDetail.sessionScores[sessionId];
                    
                    if (sessionScore.absent) {
                        totalScore += sessionScore.absentPoints || scoreConfig.absent;
                    }
                    
                    if (sessionScore.noClassNotes) {
                        totalScore += sessionScore.noClassNotesPoints || scoreConfig.noClassNotes;
                    }
                    
                    if (sessionScore.noHomework) {
                        totalScore += sessionScore.noHomeworkPoints || scoreConfig.noHomework;
                    }
                    
                    if (sessionScore.writesNotes) {
                        totalScore += sessionScore.writesNotesPoints || scoreConfig.writesNotes;
                    }
                    
                    if (sessionScore.extraClasses) {
                        totalScore += sessionScore.extraClassesPoints || scoreConfig.extraClasses;
                    }
                    
                    if (sessionScore.motahhariStudy) {
                        totalScore += sessionScore.motahhariStudyPoints || scoreConfig.motahhariStudy;
                    }
                });
            }
            
            return totalScore;
        }
        
        function renderStats() {
            const statsGrid = document.getElementById('statsGrid');
            
            const totalSessions = sessions.length;
            const totalStudents = students.length;
            
            let totalAttendance = 0;
            let totalAbsence = 0;
            
            Object.keys(attendance).forEach(sessionId => {
                const sessionAttendance = attendance[sessionId];
                Object.keys(sessionAttendance).forEach(studentId => {
                    if (sessionAttendance[studentId]) {
                        totalAttendance++;
                    } else {
                        totalAbsence++;
                    }
                });
            });
            
            const avgScore = students.length > 0 ? 
                students.reduce((sum, student) => sum + calculateStudentScore(student.id), 0) / students.length : 0;
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalSessions}</div>
                    <div class="stat-label">تعداد جلسات</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalStudents}</div>
                    <div class="stat-label">تعداد دانشجویان</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalAttendance}</div>
                    <div class="stat-label">حضور کل</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalAbsence}</div>
                    <div class="stat-label">غیبت کل</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avgScore.toFixed(1)}</div>
                    <div class="stat-label">میانگین امتیاز</div>
                </div>
            `;
        }
        
        function exportToExcel() {
            if (students.length === 0) {
                alert('هیچ دانشجویی برای خروجی وجود ندارد');
                return;
            }
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Create students data
            const studentData = students.map(student => {
                const studentDetail = studentDetails[student.id] || {};
                const totalScore = calculateStudentScore(student.id);
                
                return {
                    'نام دانشجو': student.name,
                    'توضیحات': student.notes,
                    'شهر': studentDetail.city || '',
                    'رشته اصلی': studentDetail.major || '',
                    'رشته فرعی': studentDetail.minor || '',
                    'متأهل': studentDetail.isMarried ? 'بله' : 'خیر',
                    'فرزند': studentDetail.hasChild ? 'بله' : 'خیر',
                    'شغل': studentDetail.hasJob ? 'بله' : 'خیر',
                    'مقام/قهرمانی': studentDetail.hasAchievement ? 'بله' : 'خیر',
                    'کتاب‌ها': (studentDetail.books || []).map(b => b.name).join(', '),
                    'فیلم‌ها': (studentDetail.movies || []).map(m => m.name).join(', '),
                    'سریال‌ها': (studentDetail.series || []).map(s => s.name).join(', '),
                    'امتیاز کل': totalScore
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(studentData);
            XLSX.utils.book_append_sheet(wb, ws, 'دانشجویان');
            
            // Create attendance data
            if (sessions.length > 0) {
                const attendanceData = [];
                
                students.forEach(student => {
                    const row = { 'نام دانشجو': student.name };
                    
                    sessions.forEach(session => {
                        const isPresent = attendance[session.id] && attendance[session.id][student.id] !== false;
                        row[session.title] = isPresent ? 'حاضر' : 'غایب';
                    });
                    
                    attendanceData.push(row);
                });
                
                const ws2 = XLSX.utils.json_to_sheet(attendanceData);
                XLSX.utils.book_append_sheet(wb, ws2, 'حضور و غیاب');
            }
            
            // Export file
            XLSX.writeFile(wb, 'استادیار_گزارش.xlsx');
        }
        
        function saveData() {
            const data = {
                sessions,
                students,
                attendance,
                studentDetails
            };
            
            localStorage.setItem('استادیار', JSON.stringify(data));
        }
        
        function loadData() {
            const data = JSON.parse(localStorage.getItem('استادیار'));
            
            if (data) {
                sessions = data.sessions || [];
                students = data.students || [];
                attendance = data.attendance || {};
                studentDetails = data.studentDetails || {};
            }
        }
        
        // Gregorian to Jalali conversion function
        function gregorianToJalali(gy, gm, gd) {
            var g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
            var jy = (gy <= 1600) ? 0 : 979;
            gy -= (gy <= 1600) ? 621 : 1600;
            var gy2 = (gm > 2) ? (gy + 1) : gy;
            var days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
            jy += 33 * (parseInt(days / 12053));
            days %= 12053;
            jy += 4 * (parseInt(days / 1461));
            days %= 1461;
            jy += parseInt((days - 1) / 365);
            if (days > 365) days = (days - 1) % 365;
            var jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
            var jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
            return [jy, jm, jd];
        }
    </script>
</body>
</html>
